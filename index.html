<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Primal Fuse</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
  }

  :root {
    --bg: #1a1a2e;
    --card: #16213e;
    --card-hover: #1e2f5e;
    --accent: #ffd700;
    --text: #e0e0e0;
    --text-muted: #888;
    --border: #2a2a4a;
    --cell-size: 72px;
    --cell-gap: 6px;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Segoe UI', system-ui, sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    user-select: none;
  }

  header {
    padding: 16px 20px 8px;
    text-align: center;
    width: 100%;
  }

  h1 {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: 2px;
    color: var(--accent);
    text-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
  }

  h1 span {
    color: var(--text-muted);
    font-size: 14px;
    font-weight: 400;
    letter-spacing: 1px;
    display: block;
    margin-top: 2px;
  }

  .score-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    justify-content: center;
    padding: 8px 20px;
    font-size: 14px;
    color: var(--text-muted);
  }

  .score-bar .discovery-count {
    color: var(--accent);
    font-weight: 700;
    font-size: 16px;
  }

  .main-layout {
    display: flex;
    gap: 20px;
    padding: 10px 20px 20px;
    align-items: flex-start;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 900px;
    width: 100%;
  }

  /* --- ã‚°ãƒªãƒƒãƒ‰ --- */
  .grid-wrapper {
    position: relative;
  }

  #grid {
    display: grid;
    grid-template-columns: repeat(6, var(--cell-size));
    grid-template-rows: repeat(6, var(--cell-size));
    gap: var(--cell-gap);
    background: var(--card);
    border-radius: 16px;
    padding: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    touch-action: none;
  }

  .cell {
    width: var(--cell-size);
    height: var(--cell-size);
    border-radius: 10px;
    background: var(--bg);
    border: 2px solid transparent;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.15s, border-color 0.15s, background 0.15s;
    position: relative;
    overflow: hidden;
  }

  .cell .emoji {
    font-size: 28px;
    line-height: 1;
    transition: transform 0.15s;
    pointer-events: none;
  }

  .cell .label {
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    opacity: 0.7;
    margin-top: 2px;
    pointer-events: none;
  }

  .cell.empty {
    opacity: 0.3;
    cursor: default;
  }

  /* é¸æŠä¸­ã®å¼·èª¿ */
  .cell.selected {
    border-color: var(--accent);
    background: rgba(255, 215, 0, 0.08);
    transform: scale(1.06);
    z-index: 2;
  }

  /* ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ */
  .cell.droppable {
    border-color: #6cf;
    background: rgba(100, 200, 255, 0.1);
    animation: pulse-droppable 0.8s ease-in-out infinite;
  }

  @keyframes pulse-droppable {
    0%, 100% { box-shadow: 0 0 0 0 rgba(100, 200, 255, 0.3); }
    50%       { box-shadow: 0 0 0 6px rgba(100, 200, 255, 0); }
  }

  /* ãƒãƒ¼ã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: 0.8â†’1.2â†’1.0 */
  @keyframes merge-pop {
    0%   { transform: scale(0.8); }
    50%  { transform: scale(1.25); }
    100% { transform: scale(1.0); }
  }

  .cell.merge-anim {
    animation: merge-pop 0.35s cubic-bezier(0.36, 0.07, 0.19, 0.97) forwards;
  }

  /* è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes fall-in {
    0%   { opacity: 0; transform: translateY(-20px) scale(0.7); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
  }

  .cell.fall-anim {
    animation: fall-in 0.3s ease-out forwards;
  }

  /* --- å›³é‘‘ã‚µã‚¤ãƒ‰ãƒãƒ¼ --- */
  .compendium {
    background: var(--card);
    border-radius: 16px;
    padding: 16px;
    min-width: 180px;
    max-width: 200px;
    border: 1px solid var(--border);
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }

  .compendium h2 {
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  .compendium-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .comp-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    border-radius: 8px;
    background: var(--bg);
    transition: background 0.2s;
    font-size: 12px;
  }

  .comp-item.discovered {
    background: rgba(255, 215, 0, 0.06);
  }

  .comp-item .comp-emoji {
    font-size: 18px;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
  }

  .comp-item .comp-name {
    font-weight: 600;
    text-transform: capitalize;
  }

  .comp-item.undiscovered .comp-emoji,
  .comp-item.undiscovered .comp-name {
    opacity: 0.15;
  }

  .comp-item .comp-badge {
    margin-left: auto;
    font-size: 9px;
    padding: 2px 5px;
    border-radius: 4px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  .comp-badge.new {
    background: var(--accent);
    color: #1a1a2e;
  }

  /* --- æ–°ç™ºè¦‹æ¼”å‡º --- */
  #discovery-toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: rgba(26, 26, 46, 0.95);
    border: 2px solid var(--accent);
    border-radius: 16px;
    padding: 20px 32px;
    text-align: center;
    z-index: 100;
    pointer-events: none;
    box-shadow: 0 0 40px rgba(255, 215, 0, 0.3);
    transition: transform 0.25s cubic-bezier(0.36, 0.07, 0.19, 0.97);
  }

  #discovery-toast.show {
    transform: translate(-50%, -50%) scale(1);
  }

  #discovery-toast .toast-label {
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent);
    font-weight: 700;
  }

  #discovery-toast .toast-emoji {
    font-size: 48px;
    display: block;
    margin: 8px 0;
  }

  #discovery-toast .toast-name {
    font-size: 20px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* --- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
  #gameover-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }

  #gameover-modal.show {
    display: flex;
  }

  .modal-box {
    background: var(--card);
    border: 2px solid var(--accent);
    border-radius: 20px;
    padding: 36px 48px;
    text-align: center;
    max-width: 360px;
    box-shadow: 0 0 60px rgba(255, 215, 0, 0.2);
  }

  .modal-box h2 {
    font-size: 28px;
    font-weight: 900;
    color: var(--accent);
    margin-bottom: 8px;
    letter-spacing: 2px;
  }

  .modal-box p {
    color: var(--text-muted);
    font-size: 14px;
    margin-bottom: 24px;
    line-height: 1.6;
  }

  .modal-box .final-score {
    font-size: 36px;
    font-weight: 900;
    color: var(--text);
    margin-bottom: 8px;
  }

  .modal-box .final-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    margin-bottom: 24px;
    display: block;
  }

  .btn-restart {
    background: var(--accent);
    color: #1a1a2e;
    border: none;
    border-radius: 10px;
    padding: 12px 32px;
    font-size: 16px;
    font-weight: 800;
    letter-spacing: 1px;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    text-transform: uppercase;
  }

  .btn-restart:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 16px rgba(255, 215, 0, 0.4);
  }

  /* --- ãƒ’ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆ --- */
  .hint {
    font-size: 11px;
    color: var(--text-muted);
    text-align: center;
    padding: 0 20px 12px;
  }

  /* --- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– --- */
  @media (max-width: 600px) {
    :root {
      --cell-size: 52px;
      --cell-gap: 4px;
    }
    .cell .emoji { font-size: 20px; }
    .cell .label { font-size: 7px; }
    h1 { font-size: 22px; }
    .compendium { max-width: 100%; min-width: unset; width: 100%; }
    .main-layout { gap: 12px; padding: 8px 12px; }
  }
</style>
</head>
<body>

<header>
  <h1>PRIMAL FUSE <span>element merge puzzle</span></h1>
</header>

<div class="score-bar">
  <span>Discovered:</span>
  <span class="discovery-count" id="disc-count">0 / 10</span>
  <span>elements</span>
</div>

<p class="hint">Click an element, then click an adjacent same-type to merge</p>

<div class="main-layout">
  <div class="grid-wrapper">
    <div id="grid"></div>
  </div>

  <div class="compendium">
    <h2>Compendium</h2>
    <div class="compendium-list" id="compendium-list"></div>
  </div>
</div>

<!-- æ–°ç™ºè¦‹æ¼”å‡º -->
<div id="discovery-toast">
  <div class="toast-label">NEW DISCOVERY!</div>
  <span class="toast-emoji" id="toast-emoji"></span>
  <div class="toast-name" id="toast-name"></div>
</div>

<!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="gameover-modal">
  <div class="modal-box">
    <h2>GAME OVER</h2>
    <p>No more merges available.<br>The grid has crystallized.</p>
    <div class="final-score" id="final-score">0</div>
    <span class="final-label">elements discovered</span>
    <br>
    <button class="btn-restart" onclick="initGame()">Play Again</button>
  </div>
</div>

<script>
'use strict';

// =====================================================
// å…ƒç´ å®šç¾©
// åˆæˆãƒ«ãƒ¼ãƒ«ã¯ã€Œå‡ºåŠ›IDã‚’ã‚­ãƒ¼ã€ã§ã¯ãªãã€Œå…¥åŠ›ãƒšã‚¢ã‚’ã‚­ãƒ¼ã€ã§ç®¡ç†ã™ã‚‹ã€‚
// ã“ã‚Œã«ã‚ˆã‚ŠåŒã˜å…ƒç´ ã®çµ„ã¿åˆã‚ã›ãŒåˆ¥ã®çµæœã«ãªã‚‹ã“ã¨ã‚’é˜²ãã€‚
// =====================================================
const ELEMENTS = {
  fire:  { id: 'fire',  emoji: 'ğŸ”¥', label: 'Fire',  color: '#e94560', layer: 1 },
  water: { id: 'water', emoji: 'ğŸ’§', label: 'Water', color: '#4fc3f7', layer: 1 },
  earth: { id: 'earth', emoji: 'ğŸŒ', label: 'Earth', color: '#8bc34a', layer: 1 },
  wind:  { id: 'wind',  emoji: 'ğŸ’¨', label: 'Wind',  color: '#b0bec5', layer: 1 },

  lava:  { id: 'lava',  emoji: 'ğŸŒ‹', label: 'Lava',  color: '#ff6f00', layer: 2 },
  ice:   { id: 'ice',   emoji: 'â„ï¸', label: 'Ice',   color: '#80deea', layer: 2 },
  sand:  { id: 'sand',  emoji: 'ğŸœï¸', label: 'Sand',  color: '#f9a825', layer: 2 },
  storm: { id: 'storm', emoji: 'â›ˆï¸', label: 'Storm', color: '#7e57c2', layer: 2 },
  steam: { id: 'steam', emoji: 'ğŸ’¨', label: 'Steam', color: '#b2dfdb', layer: 2 },
  dust:  { id: 'dust',  emoji: 'ğŸŒ€', label: 'Dust',  color: '#a5d6a7', layer: 2 },
};

// steam ã¨ wind ãŒåŒã˜çµµæ–‡å­—ãªã®ã§ãƒ©ãƒ™ãƒ«ã§åŒºåˆ¥ã€‚
// åˆæˆãƒ«ãƒ¼ãƒ«: ã‚½ãƒ¼ãƒˆã—ã¦æ­£è¦åŒ–ã™ã‚‹ã“ã¨ã§ A+B = B+A ã‚’ä¿è¨¼ã™ã‚‹
const MERGE_RULES = {
  'fire+fire':   'lava',
  'water+water': 'ice',
  'earth+earth': 'sand',
  'wind+wind':   'storm',
  'fire+water':  'steam',
  'earth+wind':  'dust',
};

// åˆæœŸé…ç½®ã§å‡ºç¾ã™ã‚‹åŸºæœ¬å…ƒç´ ã®ã¿ï¼ˆLayer1ï¼‰
const BASE_ELEMENTS = ['fire', 'water', 'earth', 'wind'];

const GRID_SIZE = 6;

// ã‚²ãƒ¼ãƒ çŠ¶æ…‹
let grid = [];          // grid[row][col] = elementId | null
let discovered = {};    // { elementId: true }
let selectedCell = null; // { row, col }
let droppableCells = []; // ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ãªã‚»ãƒ«
let gameOver = false;

// DOMå‚ç…§
const gridEl = document.getElementById('grid');
const discCountEl = document.getElementById('disc-count');
const compendiumEl = document.getElementById('compendium-list');
const toast = document.getElementById('discovery-toast');
const toastEmoji = document.getElementById('toast-emoji');
const toastName = document.getElementById('toast-name');
const gameoverModal = document.getElementById('gameover-modal');
const finalScoreEl = document.getElementById('final-score');

// =====================================================
// ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
// =====================================================
function initGame() {
  gameOver = false;
  selectedCell = null;
  droppableCells = [];

  // localStorageã‹ã‚‰å›³é‘‘ã‚’å¾©å…ƒï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã§ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã‚’ä¿æŒï¼‰
  try {
    const saved = localStorage.getItem('primalfuse_discovered');
    discovered = saved ? JSON.parse(saved) : {};
  } catch {
    discovered = {};
  }

  // ã‚°ãƒªãƒƒãƒ‰ã‚’åŸºæœ¬å…ƒç´ ã§ãƒ©ãƒ³ãƒ€ãƒ åŸ‹ã‚ï¼ˆ30%ç¨‹åº¦ã¯ç©ºç™½ã«ã—ã¦æ“ä½œä½™åœ°ã‚’ä½œã‚‹ï¼‰
  grid = Array.from({ length: GRID_SIZE }, () =>
    Array.from({ length: GRID_SIZE }, () => {
      // ç´„75%ã®ç¢ºç‡ã§å…ƒç´ ã‚’é…ç½®ã€25%ã¯ç©º
      return Math.random() < 0.75
        ? BASE_ELEMENTS[Math.floor(Math.random() * BASE_ELEMENTS.length)]
        : null;
    })
  );

  // åŸºæœ¬å…ƒç´ ã‚’å›³é‘‘ã«è‡ªå‹•ç™»éŒ²ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæœ€åˆã‹ã‚‰çŸ¥ã£ã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã¦æ‰±ã†ï¼‰
  BASE_ELEMENTS.forEach(id => { discovered[id] = true; });
  saveDiscovered();

  gameoverModal.classList.remove('show');
  renderGrid();
  renderCompendium();
  updateScoreBar();
}

// =====================================================
// åˆæˆãƒ«ãƒ¼ãƒ«ã®å‚ç…§
// ã‚½ãƒ¼ãƒˆã—ã¦ "a+b" å½¢å¼ã®ã‚­ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§é †åºéä¾å­˜ã«ã™ã‚‹
// =====================================================
function getMergeResult(idA, idB) {
  const key = [idA, idB].sort().join('+');
  return MERGE_RULES[key] || null;
}

// =====================================================
// ã‚»ãƒ«æ“ä½œ
// =====================================================
function getCellEl(row, col) {
  // ã‚°ãƒªãƒƒãƒ‰DOMã¯1æ¬¡å…ƒãªã®ã§ row*GRID_SIZE+col ã§å–å¾—
  return gridEl.children[row * GRID_SIZE + col];
}

function selectCell(row, col) {
  // åŒã˜ã‚»ãƒ«ã‚’å†ã‚¯ãƒªãƒƒã‚¯ â†’ é¸æŠè§£é™¤
  if (selectedCell && selectedCell.row === row && selectedCell.col === col) {
    clearSelection();
    return;
  }

  const elemId = grid[row][col];
  if (!elemId) return; // ç©ºã‚»ãƒ«ã¯é¸æŠä¸å¯

  clearSelection();

  selectedCell = { row, col };
  getCellEl(row, col).classList.add('selected');

  // ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ãªéš£æ¥ã‚»ãƒ«ã‚’è¨ˆç®—ã—ã¦å¼·èª¿
  droppableCells = getAdjacentMergeable(row, col, elemId);
  droppableCells.forEach(({ r, c }) => {
    getCellEl(r, c).classList.add('droppable');
  });
}

// éš£æ¥ã™ã‚‹åŒç¨®ã‚»ãƒ«ï¼ˆãƒãƒ¼ã‚¸å¯èƒ½ãªå¯¾è±¡ï¼‰ã‚’è¿”ã™
function getAdjacentMergeable(row, col, elemId) {
  const dirs = [[-1,0],[1,0],[0,-1],[0,1]];
  return dirs
    .map(([dr, dc]) => ({ r: row + dr, c: col + dc }))
    .filter(({ r, c }) =>
      r >= 0 && r < GRID_SIZE &&
      c >= 0 && c < GRID_SIZE &&
      grid[r][c] === elemId
    );
}

function clearSelection() {
  if (selectedCell) {
    getCellEl(selectedCell.row, selectedCell.col).classList.remove('selected');
    selectedCell = null;
  }
  droppableCells.forEach(({ r, c }) => {
    getCellEl(r, c).classList.remove('droppable');
  });
  droppableCells = [];
}

// =====================================================
// ãƒãƒ¼ã‚¸å®Ÿè¡Œ
// mergeã¸ã®ä¾µå…¥å£ã¯ clickCell ã®ã¿
// =====================================================
function clickCell(row, col) {
  if (gameOver) return;
  const elemId = grid[row][col];

  if (!selectedCell) {
    // ã¾ã é¸æŠãªã— â†’ ã“ã®ã‚»ãƒ«ã‚’é¸æŠ
    if (elemId) selectCell(row, col);
    return;
  }

  // é¸æŠæ¸ˆã¿çŠ¶æ…‹ã§ã‚¯ãƒªãƒƒã‚¯
  const isDroppable = droppableCells.some(({ r, c }) => r === row && c === col);

  if (isDroppable) {
    // ãƒãƒ¼ã‚¸å®Ÿè¡Œ
    mergeElements(selectedCell.row, selectedCell.col, row, col);
  } else {
    // åˆ¥ã®ã‚»ãƒ«ã¸é¸æŠå¤‰æ›´ï¼ˆã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
    clearSelection();
    if (elemId && !(row === selectedCell?.row && col === selectedCell?.col)) {
      selectCell(row, col);
    }
  }
}

// =====================================================
// åˆæˆå‡¦ç†
// æ–°å…ƒç´ ã‚’ã€Œãƒ‰ãƒ­ãƒƒãƒ—å…ˆï¼ˆcolå´ï¼‰ã€ã«é…ç½®ã—ã€ã€Œå…ƒã®ã‚»ãƒ«ï¼ˆselectedå´ï¼‰ã€ã‚’ç©ºã«ã™ã‚‹
// ç©ºã«ãªã£ãŸã‚¹ãƒ­ãƒƒãƒˆã¯ä¸Šã‹ã‚‰è£œå……ã™ã‚‹
// =====================================================
function mergeElements(fromRow, fromCol, toRow, toCol) {
  const idA = grid[fromRow][fromCol];
  const idB = grid[toRow][toCol];
  const resultId = getMergeResult(idA, idB);

  if (!resultId) {
    // åˆæˆãƒ«ãƒ¼ãƒ«ãªã—ï¼ˆå®šç¾©æ¼ã‚Œï¼‰â†’ ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦ç„¡è¦–
    clearSelection();
    return;
  }

  clearSelection();

  // ã‚°ãƒªãƒƒãƒ‰æ›´æ–°
  grid[toRow][toCol] = resultId;
  grid[fromRow][fromCol] = null;

  // å›³é‘‘ç™»éŒ²ãƒã‚§ãƒƒã‚¯
  const isNew = !discovered[resultId];
  if (isNew) {
    discovered[resultId] = true;
    saveDiscovered();
    showDiscoveryToast(resultId);
  }

  // ãƒãƒ¼ã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  const targetCellEl = getCellEl(toRow, toCol);
  renderCell(toRow, toCol);
  targetCellEl.classList.add('merge-anim');
  targetCellEl.addEventListener('animationend', () => {
    targetCellEl.classList.remove('merge-anim');
  }, { once: true });

  // ç©ºã«ãªã£ãŸã‚»ãƒ«ã‚’ã‚¯ãƒªã‚¢è¡¨ç¤º
  renderCell(fromRow, fromCol);

  // ä¸Šã‹ã‚‰è£œå……ï¼ˆé‡åŠ›è½ä¸‹ï¼‰
  replenishColumn(fromCol);

  updateScoreBar();
  renderCompendium();

  // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®šï¼ˆè£œå……å¾Œã«å°‘ã—é…å»¶ã—ã¦ç¢ºèªï¼‰
  setTimeout(() => {
    if (isGameOver()) triggerGameOver();
  }, 600);
}

// =====================================================
// åˆ—è£œå……ï¼ˆé‡åŠ›ï¼‰: ç©ºã«ãªã£ãŸã‚»ãƒ«ã«ä¸Šã‹ã‚‰æ–°å…ƒç´ ã‚’è½ã¨ã™
// 2048ãƒ©ã‚¤ã‚¯ã«ã€Œç©ºã‚»ãƒ«ãŒã‚ã‚Œã°ä¸Šã‹ã‚‰æ–°è¦ç´ ã‚’è£œå……ã€ã™ã‚‹
// =====================================================
function replenishColumn(col) {
  // ä¸Šâ†’ä¸‹ã®é †ã§nullã‚’æ¢ã—ã€ä¸Šã‹ã‚‰è©°ã‚ã‚‹
  const column = [];
  for (let r = 0; r < GRID_SIZE; r++) {
    column.push(grid[r][col]);
  }

  // nullä»¥å¤–ã‚’å…ˆã«é›†ã‚ã€è¶³ã‚Šãªã„åˆ†ã‚’ãƒ©ãƒ³ãƒ€ãƒ è£œå……
  const filled = column.filter(v => v !== null);
  while (filled.length < GRID_SIZE) {
    // Layer2å…ƒç´ ã¯ã¾ã‚Œã«ï¼ˆ5%ï¼‰å‡ºç¾ã—ã€åŸºæœ¬ã¯åŸºæœ¬å…ƒç´ ã‚’è£œå……ã™ã‚‹
    // ã“ã‚Œã«ã‚ˆã‚Šé›£æ˜“åº¦ãŒè‡ªç„¶ã«ä¸ŠãŒã‚Šã™ããªã„
    filled.unshift(
      Math.random() < 0.05
        ? 'lava' // ç¨€ã«Layer2
        : BASE_ELEMENTS[Math.floor(Math.random() * BASE_ELEMENTS.length)]
    );
  }

  for (let r = 0; r < GRID_SIZE; r++) {
    const old = grid[r][col];
    grid[r][col] = filled[r];
    if (old !== filled[r]) {
      // æ–°ã—ãé™ã£ã¦ããŸã‚»ãƒ«ã«è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      const cellEl = getCellEl(r, col);
      renderCell(r, col);
      cellEl.classList.add('fall-anim');
      cellEl.addEventListener('animationend', () => {
        cellEl.classList.remove('fall-anim');
      }, { once: true });
    }
  }
}

// =====================================================
// ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
// ã€ŒåŒç¨®ã®éš£æ¥ãƒšã‚¢ãŒå…¨ããªã„ã€= ãƒãƒ¼ã‚¸ä¸å¯èƒ½
// å®Ÿè£…ã‚’ç°¡æ½”ã«ã™ã‚‹ãŸã‚å…¨ã‚»ãƒ«ã‚’èµ°æŸ»ã—ã¦ãƒšã‚¢ã‚’æ¢ã™
// =====================================================
function isGameOver() {
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      const id = grid[r][c];
      if (!id) continue;
      // å³ã¨ä¸‹ã®éš£æ¥ã ã‘ãƒã‚§ãƒƒã‚¯ã™ã‚Œã°å…¨ãƒšã‚¢ã‚’é‡è¤‡ãªãç¶²ç¾…ã§ãã‚‹
      if (c + 1 < GRID_SIZE && grid[r][c+1] === id) return false;
      if (r + 1 < GRID_SIZE && grid[r+1][c] === id) return false;
    }
  }
  return true; // ãƒãƒ¼ã‚¸å¯èƒ½ãƒšã‚¢ãŒã‚¼ãƒ­
}

function triggerGameOver() {
  gameOver = true;
  const count = Object.keys(discovered).filter(id => !BASE_ELEMENTS.includes(id)).length;
  finalScoreEl.textContent = `${Object.keys(discovered).length} / 10`;
  gameoverModal.classList.add('show');
}

// =====================================================
// æ–°ç™ºè¦‹æ¼”å‡º
// =====================================================
let toastTimer = null;

function showDiscoveryToast(elementId) {
  const elem = ELEMENTS[elementId];
  toastEmoji.textContent = elem.emoji;
  toastName.textContent = elem.label;

  if (toastTimer) clearTimeout(toastTimer);
  toast.classList.add('show');

  toastTimer = setTimeout(() => {
    toast.classList.remove('show');
    toastTimer = null;
  }, 1800);
}

// =====================================================
// ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
// =====================================================
function renderGrid() {
  gridEl.innerHTML = '';
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      const cellEl = document.createElement('div');
      cellEl.className = 'cell';
      cellEl.dataset.row = r;
      cellEl.dataset.col = c;

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      cellEl.addEventListener('click', () => clickCell(r, c));

      gridEl.appendChild(cellEl);
      renderCell(r, c); // å†…å®¹ã‚’æç”»
    }
  }

  // ã‚¿ãƒƒãƒã‚µãƒãƒ¼ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«å‘ã‘ï¼‰
  setupTouchEvents();
}

// ã‚»ãƒ«å˜ä½“ã®å†…å®¹ã‚’æ›´æ–°ï¼ˆinnerHTMLå…¨æ›´æ–°ã‚ˆã‚Šé«˜é€Ÿï¼‰
function renderCell(row, col) {
  const cellEl = getCellEl(row, col);
  const elemId = grid[row][col];

  // æ—¢å­˜ã®é¸æŠ/ãƒ‰ãƒ­ãƒƒãƒ—çŠ¶æ…‹ã‚¯ãƒ©ã‚¹ã¯ä¿æŒã—ã¤ã¤å†…å®¹ã‚’æ›´æ–°
  cellEl.classList.remove('merge-anim', 'fall-anim');

  if (!elemId) {
    cellEl.classList.add('empty');
    cellEl.innerHTML = '';
    cellEl.style.borderColor = '';
    cellEl.style.background = '';
    return;
  }

  cellEl.classList.remove('empty');
  const elem = ELEMENTS[elemId];
  cellEl.innerHTML = `
    <span class="emoji">${elem.emoji}</span>
    <span class="label" style="color:${elem.color}">${elem.label}</span>
  `;
  // ãƒœãƒ¼ãƒ€ãƒ¼è‰²ã§å…ƒç´ ã®ç¨®é¡ã‚’ç¤ºã™ï¼ˆé¸æŠä¸­ã¯ä¸Šæ›¸ãã•ã‚Œã‚‹ï¼‰
  cellEl.style.borderColor = elem.color + '55'; // è–„ã‚
  cellEl.style.background = elem.color + '18';  // ã•ã‚‰ã«è–„ã‚
}

function renderCompendium() {
  compendiumEl.innerHTML = '';
  const allIds = Object.keys(ELEMENTS);

  allIds.forEach(id => {
    const elem = ELEMENTS[id];
    const isDisc = !!discovered[id];
    const item = document.createElement('div');
    item.className = `comp-item ${isDisc ? 'discovered' : 'undiscovered'}`;

    item.innerHTML = `
      <span class="comp-emoji">${elem.emoji}</span>
      <span class="comp-name" style="${isDisc ? `color:${elem.color}` : ''}">${isDisc ? elem.label : '???'}</span>
    `;
    compendiumEl.appendChild(item);
  });
}

function updateScoreBar() {
  const total = Object.keys(ELEMENTS).length;
  const count = Object.keys(discovered).length;
  discCountEl.textContent = `${count} / ${total}`;
}

// =====================================================
// ã‚¿ãƒƒãƒæ“ä½œï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
// touchstartã§é¸æŠã€touchendã§ç¢ºå®š
// =====================================================
function setupTouchEvents() {
  let touchStartCell = null;

  gridEl.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    const target = document.elementFromPoint(touch.clientX, touch.clientY);
    const cellEl = target?.closest('.cell');
    if (!cellEl) return;
    touchStartCell = {
      row: parseInt(cellEl.dataset.row),
      col: parseInt(cellEl.dataset.col),
    };
  }, { passive: false });

  gridEl.addEventListener('touchend', (e) => {
    e.preventDefault();
    const touch = e.changedTouches[0];
    const target = document.elementFromPoint(touch.clientX, touch.clientY);
    const cellEl = target?.closest('.cell');
    if (!cellEl || !touchStartCell) { touchStartCell = null; return; }

    const endRow = parseInt(cellEl.dataset.row);
    const endCol = parseInt(cellEl.dataset.col);

    if (touchStartCell.row === endRow && touchStartCell.col === endCol) {
      // åŒã‚»ãƒ«ã‚¿ãƒƒãƒ— = ã‚¯ãƒªãƒƒã‚¯ã¨åŒç­‰
      clickCell(endRow, endCol);
    } else {
      // åˆ¥ã‚»ãƒ«ã¸ã®ã‚¹ãƒ¯ã‚¤ãƒ—: é–‹å§‹ã‚»ãƒ«ã‚’é¸æŠâ†’çµ‚äº†ã‚»ãƒ«ã«ãƒ‰ãƒ­ãƒƒãƒ—
      if (!selectedCell) {
        selectCell(touchStartCell.row, touchStartCell.col);
      }
      clickCell(endRow, endCol);
    }
    touchStartCell = null;
  }, { passive: false });
}

// =====================================================
// localStorageã¸ã®å›³é‘‘ä¿å­˜
// JSON.stringifyãŒå¤±æ•—ã™ã‚‹ç’°å¢ƒï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°ç­‰ï¼‰ã«å‚™ãˆã¦try/catch
// =====================================================
function saveDiscovered() {
  try {
    localStorage.setItem('primalfuse_discovered', JSON.stringify(discovered));
  } catch {
    // localStorageãŒä½¿ãˆãªãã¦ã‚‚å‹•ä½œã¯ç¶™ç¶šã™ã‚‹
  }
}

// =====================================================
// ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
// =====================================================
initGame();
</script>
</body>
</html>
