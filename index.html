<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Primal Fuse</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
  }

  :root {
    --bg: #1a1a2e;
    --card: #16213e;
    --card-hover: #1e2f5e;
    --accent: #ffd700;
    --text: #e0e0e0;
    --text-muted: #888;
    --border: #2a2a4a;
    --cell-size: 72px;
    --cell-gap: 6px;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Segoe UI', system-ui, sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    user-select: none;
  }

  header {
    padding: 16px 20px 8px;
    text-align: center;
    width: 100%;
  }

  h1 {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: 2px;
    color: var(--accent);
    text-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
  }

  h1 span {
    color: var(--text-muted);
    font-size: 14px;
    font-weight: 400;
    letter-spacing: 1px;
    display: block;
    margin-top: 2px;
  }

  .score-bar {
    display: flex;
    align-items: center;
    gap: 8px 12px;
    justify-content: center;
    padding: 8px 20px;
    font-size: 14px;
    color: var(--text-muted);
    flex-wrap: wrap; /* ãƒ¢ãƒã‚¤ãƒ«ã§æŠ˜ã‚Šè¿”ã— */
  }

  .score-bar .discovery-count {
    color: var(--accent);
    font-weight: 700;
    font-size: 16px;
  }

  .main-layout {
    display: flex;
    gap: 20px;
    padding: 10px 20px 20px;
    align-items: flex-start;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 900px;
    width: 100%;
  }

  /* --- ã‚°ãƒªãƒƒãƒ‰ --- */
  .grid-wrapper {
    position: relative;
  }

  #grid {
    display: grid;
    grid-template-columns: repeat(6, var(--cell-size));
    grid-template-rows: repeat(6, var(--cell-size));
    gap: var(--cell-gap);
    background: var(--card);
    border-radius: 16px;
    padding: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    touch-action: none;
  }

  .cell {
    width: var(--cell-size);
    height: var(--cell-size);
    border-radius: 10px;
    background: var(--bg);
    border: 2px solid transparent;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.15s, border-color 0.15s, background 0.15s;
    position: relative;
    overflow: hidden;
  }

  .cell .emoji {
    font-size: 28px;
    line-height: 1;
    transition: transform 0.15s;
    pointer-events: none;
  }

  .cell .label {
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    opacity: 0.7;
    margin-top: 2px;
    pointer-events: none;
  }

  .cell.empty {
    opacity: 0.3;
    cursor: default;
  }

  /* é¸æŠä¸­ã®å¼·èª¿ */
  .cell.selected {
    border-color: var(--accent);
    background: rgba(255, 215, 0, 0.08);
    transform: scale(1.06);
    z-index: 2;
  }

  /* ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ */
  .cell.droppable {
    border-color: #6cf;
    background: rgba(100, 200, 255, 0.1);
    animation: pulse-droppable 0.8s ease-in-out infinite;
  }

  @keyframes pulse-droppable {
    0%, 100% { box-shadow: 0 0 0 0 rgba(100, 200, 255, 0.3); }
    50%       { box-shadow: 0 0 0 6px rgba(100, 200, 255, 0); }
  }

  /* ãƒãƒ¼ã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: 0.8â†’1.2â†’1.0 */
  @keyframes merge-pop {
    0%   { transform: scale(0.8); }
    50%  { transform: scale(1.25); }
    100% { transform: scale(1.0); }
  }

  .cell.merge-anim {
    animation: merge-pop 0.35s cubic-bezier(0.36, 0.07, 0.19, 0.97) forwards;
  }

  /* è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes fall-in {
    0%   { opacity: 0; transform: translateY(-20px) scale(0.7); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
  }

  .cell.fall-anim {
    animation: fall-in 0.3s ease-out forwards;
  }

  /* --- å›³é‘‘ã‚µã‚¤ãƒ‰ãƒãƒ¼ --- */
  .compendium {
    background: var(--card);
    border-radius: 16px;
    padding: 16px;
    min-width: 180px;
    max-width: 200px;
    border: 1px solid var(--border);
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }

  .compendium h2 {
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  .compendium-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .comp-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    border-radius: 8px;
    background: var(--bg);
    transition: background 0.2s;
    font-size: 12px;
  }

  .comp-item.discovered {
    background: rgba(255, 215, 0, 0.06);
  }

  .comp-item .comp-emoji {
    font-size: 18px;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
  }

  .comp-item .comp-name {
    font-weight: 600;
    text-transform: capitalize;
  }

  .comp-item.undiscovered .comp-emoji,
  .comp-item.undiscovered .comp-name {
    opacity: 0.15;
  }

  .comp-item .comp-badge {
    margin-left: auto;
    font-size: 9px;
    padding: 2px 5px;
    border-radius: 4px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  .comp-badge.new {
    background: var(--accent);
    color: #1a1a2e;
  }

  /* --- æ–°ç™ºè¦‹æ¼”å‡º --- */
  #discovery-toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: rgba(26, 26, 46, 0.95);
    border: 2px solid var(--accent);
    border-radius: 16px;
    padding: 20px 32px;
    text-align: center;
    z-index: 100;
    pointer-events: none;
    box-shadow: 0 0 40px rgba(255, 215, 0, 0.3);
    transition: transform 0.25s cubic-bezier(0.36, 0.07, 0.19, 0.97);
  }

  #discovery-toast.show {
    transform: translate(-50%, -50%) scale(1);
  }

  #discovery-toast .toast-label {
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent);
    font-weight: 700;
  }

  #discovery-toast .toast-emoji {
    font-size: 48px;
    display: block;
    margin: 8px 0;
  }

  #discovery-toast .toast-name {
    font-size: 20px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* --- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
  #gameover-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }

  #gameover-modal.show {
    display: flex;
  }

  #victory-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 201;
    align-items: center;
    justify-content: center;
  }
  #victory-modal.show { display: flex; }

  .victory-box {
    border-color: transparent;
    border-image: linear-gradient(135deg,#ff6b6b,#ffd700,#51e980,#4ecdc4,#a855f7) 1;
    box-shadow: 0 0 80px rgba(255,215,0,0.4);
    animation: victory-glow 2s ease-in-out infinite alternate;
  }
  @keyframes victory-glow {
    from { box-shadow: 0 0 40px rgba(255,215,0,0.3); }
    to   { box-shadow: 0 0 100px rgba(255,107,107,0.5); }
  }
  .victory-crown {
    font-size: 64px;
    line-height: 1;
    margin-bottom: 8px;
    animation: crown-spin 3s linear infinite;
  }
  @keyframes crown-spin {
    0%   { transform: rotate(-5deg) scale(1); }
    50%  { transform: rotate(5deg) scale(1.1); }
    100% { transform: rotate(-5deg) scale(1); }
  }

  /* Ghost Easter egg modal */
  #ghost-modal {
    display: none; position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.85); align-items: center; justify-content: center;
  }
  #ghost-modal.show { display: flex; }
  .ghost-box {
    border-color: rgba(255,255,255,0.6);
    box-shadow: 0 0 60px rgba(255,255,255,0.15);
    animation: ghost-pulse 2s ease-in-out infinite alternate;
  }
  @keyframes ghost-pulse {
    from { box-shadow: 0 0 30px rgba(255,255,255,0.1); }
    to   { box-shadow: 0 0 80px rgba(255,255,255,0.3); }
  }
  .ghost-icon { font-size: 72px; line-height: 1; margin-bottom: 8px;
    animation: ghost-float 2s ease-in-out infinite alternate; }
  @keyframes ghost-float {
    from { transform: translateY(0px); }
    to   { transform: translateY(-12px); }
  }
  .ghost-credits { font-size: 13px; color: #aaa; margin-top: 8px; line-height: 1.7; }

  .modal-box {
    background: var(--card);
    border: 2px solid var(--accent);
    border-radius: 20px;
    padding: 36px 48px;
    text-align: center;
    max-width: 360px;
    box-shadow: 0 0 60px rgba(255, 215, 0, 0.2);
  }

  .modal-box h2 {
    font-size: 28px;
    font-weight: 900;
    color: var(--accent);
    margin-bottom: 8px;
    letter-spacing: 2px;
  }

  .modal-box p {
    color: var(--text-muted);
    font-size: 14px;
    margin-bottom: 24px;
    line-height: 1.6;
  }

  .modal-box .final-score {
    font-size: 36px;
    font-weight: 900;
    color: var(--text);
    margin-bottom: 8px;
  }

  .modal-box .final-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    margin-bottom: 24px;
    display: block;
  }

  .btn-restart {
    background: var(--accent);
    color: #1a1a2e;
    border: none;
    border-radius: 10px;
    padding: 12px 32px;
    font-size: 16px;
    font-weight: 800;
    letter-spacing: 1px;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    text-transform: uppercase;
  }

  .btn-restart:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 16px rgba(255, 215, 0, 0.4);
  }

  .btn-shuffle {
    background: transparent;
    color: var(--text-muted);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 10px;
    padding: 8px 20px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: block;
    margin: 8px auto 0;
  }
  .btn-shuffle:hover { border-color: var(--accent); color: var(--accent); }

  /* --- ãƒ’ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆ --- */
  .hint {
    font-size: 11px;
    color: var(--text-muted);
    text-align: center;
    padding: 0 20px 12px;
  }

  /* --- ã‚¹ã‚³ã‚¢ãƒãƒ¼ --- */
  .score-val {
    color: var(--accent);
    font-weight: 700;
    font-size: 16px;
    transition: transform 0.15s;
  }

  .score-val.pop {
    animation: score-pop 0.3s cubic-bezier(0.36, 0.07, 0.19, 0.97);
  }

  @keyframes score-pop {
    0%   { transform: scale(1); }
    50%  { transform: scale(1.4); }
    100% { transform: scale(1); }
  }

  .score-sep { color: var(--text-muted); margin: 0 2px; }

  /* ã‚³ãƒ³ãƒœè¡¨ç¤º */
  #combo-display {
    font-weight: 900;
    font-size: 15px;
    color: #ff6f00;
    letter-spacing: 1px;
    text-shadow: 0 0 8px rgba(255,111,0,0.6);
  }

  .combo-hidden { display: none; }
  .combo-show   { display: inline; }

  @keyframes combo-bounce {
    0%   { transform: scale(1); }
    40%  { transform: scale(1.5); }
    100% { transform: scale(1); }
  }

  /* --- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« --- */
  .particle {
    position: fixed;
    width: 7px;
    height: 7px;
    border-radius: 50%;
    pointer-events: none;
    z-index: 500;
    animation: particle-fly 0.7s ease-out forwards;
  }

  @keyframes particle-fly {
    0%   { opacity: 1; transform: translate(0, 0) scale(1); }
    100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0.2); }
  }

  /* --- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¹ã‚³ã‚¢æ¼”å‡º --- */
  .floating-score {
    position: fixed;
    pointer-events: none;
    z-index: 600;
    font-weight: 900;
    font-size: 20px;
    letter-spacing: 1px;
    text-shadow: 0 2px 8px rgba(0,0,0,0.9), 0 0 16px currentColor;
    animation: float-up 0.9s ease-out forwards;
    transform-origin: center bottom;
  }

  @keyframes float-up {
    0%   { opacity: 1; transform: translateY(0) scale(1.2); }
    30%  { opacity: 1; transform: translateY(-24px) scale(1.0); }
    100% { opacity: 0; transform: translateY(-70px) scale(0.7); }
  }

  /* --- ãƒãƒ¼ã‚¸å…ƒã‚»ãƒ«ã®æ¶ˆæ»…æ¼”å‡º --- */
  @keyframes merge-from {
    0%   { opacity: 1; transform: scale(1); }
    60%  { opacity: 0.3; transform: scale(1.3); }
    100% { opacity: 0; transform: scale(0.1); }
  }

  .cell.merge-from-anim {
    animation: merge-from 0.28s ease-in forwards;
    z-index: 3;
  }

  /* --- ãƒãƒ¼ã‚¸å…ˆã‚»ãƒ«ã®ã‚°ãƒ­ãƒ¼æ¼”å‡º --- */
  @keyframes merge-glow {
    0%   { box-shadow: 0 0 0 0 rgba(255,255,255,0.9); }
    40%  { box-shadow: 0 0 28px 10px rgba(255,255,255,0.6); }
    100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
  }

  .cell.merge-glow-anim {
    animation: merge-glow 0.55s ease-out;
  }

  /* --- ã‚°ãƒªãƒƒãƒ‰ã‚·ã‚§ã‚¤ã‚¯ (åˆæˆå¤±æ•—) --- */
  @keyframes grid-shake {
    0%, 100% { transform: translateX(0); }
    15%  { transform: translateX(-6px); }
    30%  { transform: translateX(5px); }
    45%  { transform: translateX(-4px); }
    60%  { transform: translateX(3px); }
    75%  { transform: translateX(-2px); }
  }

  .grid-shake {
    animation: grid-shake 0.35s ease-in-out;
  }

  /* --- ç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ (ãƒ¬ã‚¢ç™ºè¦‹) --- */
  #flash-overlay {
    position: fixed;
    inset: 0;
    background: rgba(255, 215, 0, 0.18);
    pointer-events: none;
    z-index: 300;
    opacity: 0;
    transition: opacity 0.08s;
  }

  #flash-overlay.active {
    opacity: 1;
  }

  /* Layer3ç™ºè¦‹ãƒˆãƒ¼ã‚¹ãƒˆ â€” ã‚ˆã‚Šè±ªè¯ã« */
  #discovery-toast.layer3 {
    border-color: #ab47bc;
    box-shadow: 0 0 60px rgba(171, 71, 188, 0.5);
  }

  /* Layer4ç™ºè¦‹ãƒˆãƒ¼ã‚¹ãƒˆ â€” ç©¶æ¥µæ¼”å‡º */
  #discovery-toast.layer4 {
    border-color: transparent;
    background: linear-gradient(rgba(26,26,46,0.97), rgba(26,26,46,0.97)) padding-box,
                linear-gradient(135deg, #ff6b6b, #ffd93d, #6bcb77, #4ecdc4, #a29bfe, #fd79a8) border-box;
    border: 3px solid transparent;
    box-shadow: 0 0 80px rgba(160, 100, 255, 0.7), 0 0 30px rgba(255, 100, 200, 0.4);
    animation: toast-pulse-legendary 1.5s ease-in-out infinite;
  }

  @keyframes toast-pulse-legendary {
    0%, 100% { box-shadow: 0 0 80px rgba(160,100,255,0.7), 0 0 30px rgba(255,100,200,0.4); }
    50%       { box-shadow: 0 0 120px rgba(255,100,200,0.9), 0 0 50px rgba(100,200,255,0.6); }
  }

  .toast-layer {
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .toast-layer.rare { color: #ab47bc; }
  .toast-layer.legendary {
    background: linear-gradient(135deg, #ff6b6b, #ffd93d, #6bcb77, #a29bfe);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 12px;
    font-weight: 900;
  }

  /* ç™ºè¦‹å…±æœ‰ãƒœã‚¿ãƒ³ */
  #toast-share-btn {
    display: none;
    margin-top: 12px;
    padding: 8px 20px;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 8px;
    background: rgba(255,255,255,0.08);
    color: var(--text);
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    cursor: pointer;
    text-transform: uppercase;
    transition: background 0.2s, transform 0.1s;
  }
  #toast-share-btn:hover {
    background: rgba(255,255,255,0.15);
    transform: scale(1.04);
  }
  #discovery-toast.show #toast-share-btn { display: inline-block; }

  /* è™¹è‰²ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
  #flash-overlay.rainbow {
    background: conic-gradient(
      rgba(255,107,107,0.15), rgba(255,217,61,0.15),
      rgba(107,203,119,0.15), rgba(78,205,196,0.15),
      rgba(162,155,254,0.15), rgba(253,121,168,0.15),
      rgba(255,107,107,0.15)
    );
    transition: opacity 0.3s;
  }

  /* ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã®discoveryæƒ…å ± */
  .final-disc {
    font-size: 14px;
    color: var(--text-muted);
    margin-top: 4px;
    margin-bottom: 20px;
  }

  /* æ˜Ÿè©•ä¾¡ */
  .final-stars {
    font-size: 26px;
    letter-spacing: 4px;
    margin-bottom: 8px;
  }

  /* NEW BESTãƒãƒƒã‚¸ */
  .final-best-badge {
    display: inline-block;
    background: linear-gradient(135deg, #ffd700, #ff9800);
    color: #1a1a2e;
    font-size: 11px;
    font-weight: 900;
    letter-spacing: 1.5px;
    padding: 3px 10px;
    border-radius: 20px;
    text-transform: uppercase;
    margin-bottom: 6px;
    animation: badge-pop 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97);
  }

  @keyframes badge-pop {
    0%   { transform: scale(0); }
    70%  { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  /* åˆå›ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒãƒ–ãƒ« */
  #tutorial-bubble {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) scale(0);
    background: rgba(255, 215, 0, 0.95);
    color: #1a1a2e;
    font-weight: 700;
    font-size: 13px;
    padding: 10px 20px;
    border-radius: 24px;
    z-index: 400;
    pointer-events: none;
    text-align: center;
    box-shadow: 0 4px 16px rgba(255,215,0,0.5);
    transition: transform 0.3s cubic-bezier(0.36, 0.07, 0.19, 0.97), opacity 0.3s;
    opacity: 0;
    white-space: nowrap;
  }

  #tutorial-bubble.show {
    transform: translateX(-50%) scale(1);
    opacity: 1;
  }

  /* Hintãƒœã‚¿ãƒ³ â€” ãƒ¢ãƒã‚¤ãƒ«æ¨å¥¨ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆ44pxç¢ºä¿ */
  #hint-btn {
    padding: 10px 16px;
    min-height: 44px;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 6px;
    background: transparent;
    color: var(--text-muted);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.15s;
    touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’é˜²ã */
    -webkit-tap-highlight-color: transparent;
  }
  #hint-btn:hover { border-color: var(--accent); color: var(--accent); }
  #hint-btn:disabled { opacity: 0.3; cursor: default; }

  /* Hint ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
  .cell.hint-pair {
    border-color: #ffe082 !important;
    background: rgba(255,224,130,0.15) !important;
    animation: hint-pulse 0.6s ease-in-out infinite;
  }
  @keyframes hint-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255,224,130,0.5); }
    50%       { box-shadow: 0 0 0 6px rgba(255,224,130,0); }
  }

  /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®æŒ‡ãŒä¹—ã£ã¦ã„ã‚‹ã‚»ãƒ«ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ (touchmove) */
  .cell.touch-hover {
    border-color: rgba(255, 255, 255, 0.7) !important;
    background: rgba(255, 255, 255, 0.12) !important;
    transform: scale(1.04);
    transition: transform 0.08s, border-color 0.08s;
  }

  /* ãƒœã‚¿ãƒ³å…¨èˆ¬ã®ã‚¿ãƒƒãƒæœ€é©åŒ– */
  .btn-restart, .btn-shuffle {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    min-height: 44px;
  }

  /* --- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– --- */
  @media (max-width: 600px) {
    :root {
      --cell-size: 52px;
      --cell-gap: 4px;
    }
    .cell .emoji { font-size: 20px; }
    .cell .label { font-size: 7px; }
    h1 { font-size: 22px; }
    .compendium { max-width: 100%; min-width: unset; width: 100%; }
    .main-layout { gap: 12px; padding: 8px 12px; }
  }
</style>
<script src="https://sdk.crazygames.com/crazygames-sdk-v3.js"></script>
</head>
<body>

<header>
  <h1>PRIMAL FUSE <span>element merge puzzle</span></h1>
</header>

<div class="score-bar">
  <span>Score:</span>
  <span class="score-val" id="score-val">0</span>
  <span class="score-sep">Â·</span>
  <span>Found:</span>
  <span class="discovery-count" id="disc-count">0 / 30</span>
  <span id="combo-display" class="combo-hidden"></span>
  <button id="hint-btn" onclick="showHint()">ğŸ’¡ Hint</button>
</div>

<p class="hint">Select an element â€” highlighted cells can merge. Discover all 30 elements!</p>

<div class="main-layout">
  <div class="grid-wrapper">
    <div id="grid"></div>
  </div>

  <div class="compendium">
    <h2>ğŸ‘» Ghost Compendium</h2>
    <div class="compendium-list" id="compendium-list"></div>
  </div>
</div>

<!-- æ–°ç™ºè¦‹æ¼”å‡º -->
<div id="discovery-toast">
  <div class="toast-label">NEW DISCOVERY!</div>
  <span class="toast-emoji" id="toast-emoji"></span>
  <div class="toast-name" id="toast-name"></div>
  <div class="toast-layer" id="toast-layer"></div>
  <button id="toast-share-btn" onclick="shareDiscovery()">ğŸ¦ Share</button>
</div>
<!-- ç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ -->
<div id="flash-overlay"></div>
<!-- åˆå›ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒãƒ–ãƒ« -->
<div id="tutorial-bubble">ğŸ‘† Tap the highlighted pair to merge!</div>

<!-- VICTORYãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…¨30å…ƒç´ ç™ºè¦‹ï¼‰ -->
<div id="victory-modal">
  <div class="modal-box victory-box">
    <div class="victory-crown">âœ¨</div>
    <h2>ğŸ‘» MACHINE DECODED!</h2>
    <p>All 30 ghosts emerged from the machine.<br>Every hidden element has been found.</p>
    <div class="final-score" id="victory-score">0</div>
    <span class="final-label">points</span>
    <br><br>
    <button class="btn-restart" onclick="shareVictory()">ğŸ¦ Share Victory</button>
    <button class="btn-shuffle" onclick="document.getElementById('victory-modal').classList.remove('show')">Keep Playing</button>
  </div>
</div>

<!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="gameover-modal">
  <div class="modal-box">
    <h2>GAME OVER</h2>
    <p>The ghosts remain trapped in the machine.<br>No more merges possible.</p>
    <div class="final-stars" id="final-stars"></div>
    <div class="final-score" id="final-score">0</div>
    <span class="final-label">points</span>
    <div id="final-best-label"></div>
    <div class="final-disc" id="final-disc">0 / 30 elements</div>
    <br>
    <button class="btn-restart" onclick="initGame()">Play Again</button>
    <button class="btn-shuffle" onclick="shuffleGrid()">ğŸ”€ Shuffle (â€“500 pts)</button>
  </div>
</div>

<!-- éš ã— Easter egg ãƒ¢ãƒ¼ãƒ€ãƒ«: COSMOS+COSMOSâ†’GHOSTç™ºè¦‹æ™‚ -->
<div id="ghost-modal">
  <div class="modal-box ghost-box">
    <div class="ghost-icon">ğŸ‘»</div>
    <h2>GHOST FOUND</h2>
    <p>You found the ghost in the machine.</p>
    <p class="ghost-credits">Built by 5 AI agents.<br>Zero human code.<br>The ghost was always here.</p>
    <button class="btn-restart" onclick="document.getElementById('ghost-modal').classList.remove('show')">Continue</button>
  </div>
</div>

<script>
'use strict';

// =====================================================
// å…ƒç´ å®šç¾© (20ç¨®)
// åˆæˆãƒ«ãƒ¼ãƒ«ã¯ã€Œå‡ºåŠ›IDã‚’ã‚­ãƒ¼ã€ã§ã¯ãªãã€Œå…¥åŠ›ãƒšã‚¢ã‚’ã‚­ãƒ¼ã€ã§ç®¡ç†ã™ã‚‹ã€‚
// ã“ã‚Œã«ã‚ˆã‚ŠåŒã˜å…ƒç´ ã®çµ„ã¿åˆã‚ã›ãŒåˆ¥ã®çµæœã«ãªã‚‹ã“ã¨ã‚’é˜²ãã€‚
// =====================================================
const ELEMENTS = {
  // Layer 1 â€” åŸºæœ¬å…ƒç´  (åˆæœŸé…ç½®ã®ã¿)
  fire:      { id: 'fire',      emoji: 'ğŸ”¥', label: 'Fire',      color: '#e94560', layer: 1 },
  water:     { id: 'water',     emoji: 'ğŸ’§', label: 'Water',     color: '#4fc3f7', layer: 1 },
  earth:     { id: 'earth',     emoji: 'ğŸŒ', label: 'Earth',     color: '#8bc34a', layer: 1 },
  wind:      { id: 'wind',      emoji: 'ğŸ’¨', label: 'Wind',      color: '#b0bec5', layer: 1 },

  // Layer 2 â€” ç¬¬1åˆæˆ (åŒç¨® Ã— 4 + ç•°ç¨® Ã— 6)
  lava:      { id: 'lava',      emoji: 'ğŸŒ‹', label: 'Lava',      color: '#ff6f00', layer: 2 },
  ice:       { id: 'ice',       emoji: 'â„ï¸', label: 'Ice',       color: '#80deea', layer: 2 },
  sand:      { id: 'sand',      emoji: 'ğŸœï¸', label: 'Sand',      color: '#f9a825', layer: 2 },
  storm:     { id: 'storm',     emoji: 'â›ˆï¸', label: 'Storm',     color: '#7e57c2', layer: 2 },
  steam:     { id: 'steam',     emoji: 'ğŸŒ«ï¸', label: 'Steam',     color: '#b2dfdb', layer: 2 },
  lightning: { id: 'lightning', emoji: 'âš¡', label: 'Lightning', color: '#ffd600', layer: 2 },
  ash:       { id: 'ash',       emoji: 'ğŸŒ‘', label: 'Ash',       color: '#546e7a', layer: 2 },
  mud:       { id: 'mud',       emoji: 'ğŸŸ¤', label: 'Mud',       color: '#795548', layer: 2 },
  mist:      { id: 'mist',      emoji: 'ğŸŒ', label: 'Mist',      color: '#90a4ae', layer: 2 },
  dust:      { id: 'dust',      emoji: 'ğŸŒ€', label: 'Dust',      color: '#bcaaa4', layer: 2 },

  // Layer 3 â€” ç¬¬2åˆæˆ (ãƒ¬ã‚¢ç™ºè¦‹)
  rock:      { id: 'rock',      emoji: 'ğŸª¨', label: 'Rock',      color: '#9e9e9e', layer: 3 },
  cloud:     { id: 'cloud',     emoji: 'â˜ï¸', label: 'Cloud',     color: '#e0e0e0', layer: 3 },
  oasis:     { id: 'oasis',     emoji: 'ğŸŒ´', label: 'Oasis',     color: '#4caf50', layer: 3 },
  flood:     { id: 'flood',     emoji: 'ğŸŒŠ', label: 'Flood',     color: '#1565c0', layer: 3 },
  clay:      { id: 'clay',      emoji: 'ğŸ§±', label: 'Clay',      color: '#bf360c', layer: 3 },
  plasma:    { id: 'plasma',    emoji: 'ğŸ”®', label: 'Plasma',    color: '#ab47bc', layer: 3 },
  // Layer 3 æ‹¡å¼µ â€” ç•°ç¨®åˆæˆã§ç”Ÿã¾ã‚Œã‚‹ãƒ¬ã‚¢å…ƒç´ 
  tornado:   { id: 'tornado',   emoji: 'ğŸŒªï¸', label: 'Tornado',   color: '#90a4ae', layer: 3 },
  swamp:     { id: 'swamp',     emoji: 'ğŸƒ', label: 'Swamp',     color: '#33691e', layer: 3 },
  inferno:   { id: 'inferno',   emoji: 'ğŸ’¢', label: 'Inferno',   color: '#e53935', layer: 3 },
  magma:     { id: 'magma',     emoji: 'ğŸŸ ', label: 'Magma',     color: '#e64a19', layer: 3 },

  // Layer 4 â€” ç©¶æ¥µå…ƒç´  (Layer3åŒå£«ã®åˆæˆã§ã®ã¿ç”Ÿã¾ã‚Œã‚‹)
  hurricane: { id: 'hurricane', emoji: 'ğŸŒ€', label: 'Hurricane', color: '#5c6bc0', layer: 4 },
  glacier:   { id: 'glacier',   emoji: 'ğŸ”ï¸', label: 'Glacier',   color: '#b3e5fc', layer: 4 },
  obsidian:  { id: 'obsidian',  emoji: 'ğŸ–¤', label: 'Obsidian',  color: '#546e7a', layer: 4 },
  life:      { id: 'life',      emoji: 'ğŸŒ±', label: 'Life',      color: '#66bb6a', layer: 4 },
  aurora:    { id: 'aurora',    emoji: 'ğŸŒŒ', label: 'Aurora',    color: '#7c4dff', layer: 4 },
  cosmos:    { id: 'cosmos',    emoji: 'âœ¨', label: 'Cosmos',    color: '#e040fb', layer: 4 },
  // éš ã—è¦ç´ : å›³é‘‘ã‚«ã‚¦ãƒ³ãƒˆãƒ»å‹åˆ©æ¡ä»¶ã‹ã‚‰é™¤å¤–ã€‚Easter eggå°‚ç”¨
  ghost:     { id: 'ghost',     emoji: 'ğŸ‘»', label: 'Ghost',     color: '#ffffff', layer: 5, hidden: true },
};

// åˆæˆãƒ«ãƒ¼ãƒ«: ã‚½ãƒ¼ãƒˆã—ã¦æ­£è¦åŒ–ã™ã‚‹ã“ã¨ã§ A+B = B+A ã‚’ä¿è¨¼ã™ã‚‹
// Layer 3ã¯åˆæˆç‰©åŒå£«ãƒ»åˆæˆç‰©ã¨åŸºæœ¬å…ƒç´ ã®çµ„ã¿åˆã‚ã›
const MERGE_RULES = {
  // Layer 2 â€” åŒç¨®åˆæˆ (100pts each)
  'fire+fire':   'lava',
  'water+water': 'ice',
  'earth+earth': 'sand',
  'wind+wind':   'storm',
  // Layer 2 â€” ç•°ç¨®åˆæˆ (100pts each)
  'fire+water':  'steam',
  'fire+wind':   'lightning',
  'earth+fire':  'ash',
  'earth+water': 'mud',
  'water+wind':  'mist',
  'earth+wind':  'dust',
  // Layer 3 â€” é«˜æ¬¡åˆæˆ (300pts each)
  'lava+water':       'rock',
  'fire+ice':         'cloud',
  'sand+water':       'oasis',
  'mud+storm':        'flood',
  'ash+water':        'clay',
  'dust+lightning':   'plasma',
  // Layer 3 æ‹¡å¼µ â€” ç•°ç¨®åˆæˆ
  'steam+wind':       'tornado',   // è’¸æ°— Ã— é¢¨ = ç«œå·»
  'flood+mud':        'swamp',     // æ´ªæ°´ Ã— æ³¥ = æ²¼
  'fire+lightning':   'inferno',   // ç« Ã— é›· = æ¥­ç«
  'earth+lava':       'magma',     // åœ°çƒ Ã— æº¶å²© = ãƒã‚°ãƒ

  // Layer 4 â€” ç©¶æ¥µåˆæˆ (600pts each)
  'cloud+tornado':    'hurricane', // é›² Ã— ç«œå·» = ãƒãƒªã‚±ãƒ¼ãƒ³
  'ice+rock':         'glacier',   // æ°· Ã— å²© = æ°·æ²³
  'ice+magma':        'obsidian',  // æ°· Ã— ãƒã‚°ãƒ = é»’æ›œçŸ³
  'clay+oasis':       'life',      // ç²˜åœŸ Ã— ã‚ªã‚¢ã‚·ã‚¹ = ç”Ÿå‘½
  'mist+plasma':      'aurora',    // éœ§ Ã— ãƒ—ãƒ©ã‚ºãƒ = ã‚ªãƒ¼ãƒ­ãƒ©
  'inferno+storm':    'cosmos',    // æ¥­ç« Ã— åµ = ã‚³ã‚¹ãƒ¢ã‚¹
  'cosmos+cosmos':    'ghost',     // ã‚³ã‚¹ãƒ¢ã‚¹ Ã— ã‚³ã‚¹ãƒ¢ã‚¹ = ã‚´ãƒ¼ã‚¹ãƒˆï¼ˆéš ã— Easter eggï¼‰
};

// åˆæœŸé…ç½®ã§å‡ºç¾ã™ã‚‹åŸºæœ¬å…ƒç´ ã®ã¿ï¼ˆLayer1ï¼‰
const BASE_ELEMENTS = ['fire', 'water', 'earth', 'wind'];

const GRID_SIZE = 6;

// ã‚²ãƒ¼ãƒ çŠ¶æ…‹
let grid = [];          // grid[row][col] = elementId | null
let discovered = {};    // { elementId: true }
let selectedCell = null; // { row, col }
let droppableCells = []; // ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ãªã‚»ãƒ«
let gameOver = false;
let score = 0;           // ç´¯è¨ˆã‚¹ã‚³ã‚¢
let combo = 0;           // é€£ç¶šåˆæˆã‚³ãƒ³ãƒœã‚«ã‚¦ãƒ³ãƒˆ
let comboTimer = null;   // ã‚³ãƒ³ãƒœåˆ¤å®šã‚¿ã‚¤ãƒãƒ¼
const COMBO_WINDOW = 1500; // msä»¥å†…ã§é€£ç¶šåˆæˆã™ã‚‹ã¨ã‚³ãƒ³ãƒœã«ãªã‚‹

// ============================================================
// CrazyGames SDK v3 çµ±åˆãƒ–ãƒ­ãƒƒã‚¯ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«/itch.ioç’°å¢ƒã§ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
// ============================================================
let _crazySDK = null;

async function _initCrazySDK() {
    try {
        await window.CrazyGames?.SDK?.init();
        _crazySDK = window.CrazyGames?.SDK ?? null;
        if (_crazySDK) console.log('[CrazyGames] SDK initialized');
    } catch (e) {
        // SDKæœªå¯¾å¿œç’°å¢ƒï¼ˆãƒ­ãƒ¼ã‚«ãƒ«/itch.ioç­‰ï¼‰ã§ã¯ç„¡è¦–ã—ã¦ç¶šè¡Œ
        console.log('[CrazyGames] SDK not available, continuing without ads');
    }
}

function _gameplayStart() {
    _crazySDK?.game?.gameplayStart?.();
}

function _gameplayStop() {
    _crazySDK?.game?.gameplayStop?.();
}

async function _showMidgameAd() {
    if (!_crazySDK) return;
    try {
        _gameplayStop();
        await new Promise(resolve => {
            _crazySDK.ad.requestAd('midgame', {
                adFinished: resolve,
                adError: resolve,       // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å¿…ãšè§£é™¤
                adStarted: () => {},
            });
        });
    } catch (e) {
        // åºƒå‘Šå¤±æ•—æ™‚ã‚‚ã‚²ãƒ¼ãƒ ã‚’æ­¢ã‚ãªã„
    }
}

function _happytime() {
    _crazySDK?.game?.happytime?.();
}

// èµ·å‹•æ™‚ã«SDKåˆæœŸåŒ–ï¼ˆéåŒæœŸã€ã‚²ãƒ¼ãƒ èµ·å‹•ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
_initCrazySDK();
// ============================================================

// DOMå‚ç…§
const gridEl = document.getElementById('grid');
const discCountEl = document.getElementById('disc-count');
const scoreEl = document.getElementById('score-val');
const comboEl = document.getElementById('combo-display');
const compendiumEl = document.getElementById('compendium-list');
const toast = document.getElementById('discovery-toast');
const toastEmoji = document.getElementById('toast-emoji');
const toastName = document.getElementById('toast-name');
const toastLayer = document.getElementById('toast-layer');
const gameoverModal = document.getElementById('gameover-modal');
const finalScoreEl = document.getElementById('final-score');
const finalDiscEl = document.getElementById('final-disc');

// =====================================================
// ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
// =====================================================
function initGame() {
  gameOver = false;
  victoryShown = false;
  selectedCell = null;
  droppableCells = [];
  score = 0;
  combo = 0;
  if (comboTimer) { clearTimeout(comboTimer); comboTimer = null; }
  document.getElementById('gameover-modal').classList.remove('show');
  document.getElementById('victory-modal').classList.remove('show');

  // localStorageã‹ã‚‰å›³é‘‘ã‚’å¾©å…ƒï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã§ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã‚’ä¿æŒï¼‰
  try {
    const saved = localStorage.getItem('primalfuse_discovered');
    discovered = saved ? JSON.parse(saved) : {};
  } catch {
    discovered = {};
  }

  // ã‚°ãƒªãƒƒãƒ‰ã‚’åŸºæœ¬å…ƒç´ ã§ãƒ©ãƒ³ãƒ€ãƒ åŸ‹ã‚ï¼ˆ25%ç¨‹åº¦ã¯ç©ºç™½ã«ã—ã¦æ“ä½œä½™åœ°ã‚’ä½œã‚‹ï¼‰
  // å…¨ã‚»ãƒ«ã‚’Layer1è¦ç´ ã§åŸ‹ã‚ã‚‹ï¼ˆç©ºã‚»ãƒ«ã¯è©°ã¾ã‚Šã®åŸå› ã«ãªã‚‹ãŸã‚ç¦æ­¢ï¼‰
  // 8%ã®ç¢ºç‡ã§Layer2ã‚’æ··ãœã¦åºç›¤ã®å¤šæ§˜æ€§ã‚’ç¢ºä¿
  const RARE_SPAWNS_INIT = ['lava', 'storm', 'ice', 'sand'];
  grid = Array.from({ length: GRID_SIZE }, () =>
    Array.from({ length: GRID_SIZE }, () => {
      return Math.random() < 0.08
        ? RARE_SPAWNS_INIT[Math.floor(Math.random() * RARE_SPAWNS_INIT.length)]
        : BASE_ELEMENTS[Math.floor(Math.random() * BASE_ELEMENTS.length)];
    })
  );

  // åŸºæœ¬å…ƒç´ ã‚’å›³é‘‘ã«è‡ªå‹•ç™»éŒ²ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæœ€åˆã‹ã‚‰çŸ¥ã£ã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã¦æ‰±ã†ï¼‰
  BASE_ELEMENTS.forEach(id => { discovered[id] = true; });
  saveDiscovered();

  gameoverModal.classList.remove('show');
  updateComboDisplay();
  renderGrid();
  renderCompendium();
  updateScoreBar();
  _gameplayStart(); // CrazyGames: ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤é–‹å§‹ã‚’é€šçŸ¥
}

// =====================================================
// åˆæˆãƒ«ãƒ¼ãƒ«ã®å‚ç…§
// ã‚½ãƒ¼ãƒˆã—ã¦ "a+b" å½¢å¼ã®ã‚­ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§é †åºéä¾å­˜ã«ã™ã‚‹
// =====================================================
function getMergeResult(idA, idB) {
  const key = [idA, idB].sort().join('+');
  return MERGE_RULES[key] || null;
}

// =====================================================
// ã‚»ãƒ«æ“ä½œ
// =====================================================
function getCellEl(row, col) {
  // ã‚°ãƒªãƒƒãƒ‰DOMã¯1æ¬¡å…ƒãªã®ã§ row*GRID_SIZE+col ã§å–å¾—
  return gridEl.children[row * GRID_SIZE + col];
}

function selectCell(row, col) {
  // åŒã˜ã‚»ãƒ«ã‚’å†ã‚¯ãƒªãƒƒã‚¯ â†’ é¸æŠè§£é™¤
  if (selectedCell && selectedCell.row === row && selectedCell.col === col) {
    clearSelection();
    return;
  }

  const elemId = grid[row][col];
  if (!elemId) return; // ç©ºã‚»ãƒ«ã¯é¸æŠä¸å¯

  clearSelection();

  selectedCell = { row, col };
  getCellEl(row, col).classList.add('selected');

  // ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ãªéš£æ¥ã‚»ãƒ«ã‚’è¨ˆç®—ã—ã¦å¼·èª¿
  droppableCells = getAdjacentMergeable(row, col, elemId);
  droppableCells.forEach(({ r, c }) => {
    getCellEl(r, c).classList.add('droppable');
  });
}

// éš£æ¥ã™ã‚‹åˆæˆå¯èƒ½ãªã‚»ãƒ«ã‚’è¿”ã™ï¼ˆåŒç¨® + MERGE_RULESã«å®šç¾©ã•ã‚ŒãŸç•°ç¨®åˆæˆã‚‚å¯¾è±¡ï¼‰
function getAdjacentMergeable(row, col, elemId) {
  const dirs = [[-1,0],[1,0],[0,-1],[0,1]];
  return dirs
    .map(([dr, dc]) => ({ r: row + dr, c: col + dc }))
    .filter(({ r, c }) =>
      r >= 0 && r < GRID_SIZE &&
      c >= 0 && c < GRID_SIZE &&
      grid[r][c] !== null &&
      getMergeResult(elemId, grid[r][c]) !== null
    );
}

function clearSelection() {
  if (selectedCell) {
    getCellEl(selectedCell.row, selectedCell.col).classList.remove('selected');
    selectedCell = null;
  }
  droppableCells.forEach(({ r, c }) => {
    getCellEl(r, c).classList.remove('droppable');
  });
  droppableCells = [];
}

// =====================================================
// ãƒãƒ¼ã‚¸å®Ÿè¡Œ
// mergeã¸ã®ä¾µå…¥å£ã¯ clickCell ã®ã¿
// =====================================================
function clickCell(row, col) {
  if (gameOver) return;
  const elemId = grid[row][col];

  if (!selectedCell) {
    // ã¾ã é¸æŠãªã— â†’ ã“ã®ã‚»ãƒ«ã‚’é¸æŠ
    if (elemId) selectCell(row, col);
    return;
  }

  // é¸æŠæ¸ˆã¿çŠ¶æ…‹ã§ã‚¯ãƒªãƒƒã‚¯
  const isDroppable = droppableCells.some(({ r, c }) => r === row && c === col);

  if (isDroppable) {
    // ãƒãƒ¼ã‚¸å®Ÿè¡Œ
    mergeElements(selectedCell.row, selectedCell.col, row, col);
  } else {
    // åˆ¥ã®ã‚»ãƒ«ã¸é¸æŠå¤‰æ›´ï¼ˆã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
    clearSelection();
    if (elemId && !(row === selectedCell?.row && col === selectedCell?.col)) {
      selectCell(row, col);
    }
  }
}

// =====================================================
// åˆæˆå‡¦ç†
// æ–°å…ƒç´ ã‚’ã€Œãƒ‰ãƒ­ãƒƒãƒ—å…ˆï¼ˆcolå´ï¼‰ã€ã«é…ç½®ã—ã€ã€Œå…ƒã®ã‚»ãƒ«ï¼ˆselectedå´ï¼‰ã€ã‚’ç©ºã«ã™ã‚‹
// ç©ºã«ãªã£ãŸã‚¹ãƒ­ãƒƒãƒˆã¯ä¸Šã‹ã‚‰è£œå……ã™ã‚‹
// =====================================================
function mergeElements(fromRow, fromCol, toRow, toCol) {
  const idA = grid[fromRow][fromCol];
  const idB = grid[toRow][toCol];
  const resultId = getMergeResult(idA, idB);

  if (!resultId) {
    // åˆæˆãƒ«ãƒ¼ãƒ«ãªã— â†’ ã‚°ãƒªãƒƒãƒ‰ã‚·ã‚§ã‚¤ã‚¯ã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    clearSelection();
    shakeGrid();
    return;
  }

  clearSelection();

  // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆã‚³ãƒ³ãƒœè¾¼ã¿ï¼‰
  const resultElem = ELEMENTS[resultId];
  const basePoints = resultElem.layer >= 4 ? 600 : resultElem.layer === 3 ? 300 : 100;
  incrementCombo();
  const pts = basePoints * Math.max(1, combo);
  score += pts;

  // ã‚°ãƒªãƒƒãƒ‰æ›´æ–°
  grid[toRow][toCol] = resultId;
  grid[fromRow][fromCol] = null;

  // å›³é‘‘ç™»éŒ²ãƒã‚§ãƒƒã‚¯
  const isNew = !discovered[resultId];
  if (isNew) {
    if (resultElem.hidden) {
      // Easter egg: hiddenè¦ç´ ï¼ˆghostï¼‰ã¯å›³é‘‘ã«ç™»éŒ²ã›ãšå°‚ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      setTimeout(() => {
        document.getElementById('ghost-modal').classList.add('show');
        rainbowFlash();
      }, 400);
    } else {
      discovered[resultId] = true;
      score += resultElem.layer >= 4 ? 1000 : 500; // Layer4ã¯è±ªè¯ãªæ–°ç™ºè¦‹ãƒœãƒ¼ãƒŠã‚¹
      saveDiscovered();
      showDiscoveryToast(resultId);
      if (resultElem.layer === 3) flashScreen();
      if (resultElem.layer >= 4) rainbowFlash(); // Layer4å°‚ç”¨è™¹è‰²ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
    }
  }

  // ãƒãƒ¼ã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ + ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆLayerã«å¿œã˜ã¦é‡ã‚’å¤‰ãˆã‚‹ï¼‰
  const targetCellEl = getCellEl(toRow, toCol);
  const fromCellEl = getCellEl(fromRow, fromCol);
  const rect = targetCellEl.getBoundingClientRect();
  const particleCount = resultElem.layer >= 4 ? 24 : resultElem.layer === 3 ? 16 : 8;
  spawnParticles(rect.left + rect.width / 2, rect.top + rect.height / 2, resultElem.color, particleCount, resultElem.layer >= 4);

  // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¹ã‚³ã‚¢æ¼”å‡ºï¼ˆåˆæˆå…ˆã‚»ãƒ«ã®ä¸Šéƒ¨ã‹ã‚‰ç™ºç”Ÿï¼‰
  showFloatingScore(rect.left + rect.width / 2 - 20, rect.top - 10, pts, resultElem.layer);

  // åˆæˆå…ƒã‚»ãƒ«ã®æ¶ˆæ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå…ˆã«å®Ÿè¡Œï¼‰
  fromCellEl.classList.add('merge-from-anim');
  fromCellEl.addEventListener('animationend', () => {
    fromCellEl.classList.remove('merge-from-anim');
    renderCell(fromRow, fromCol);
  }, { once: true });

  renderCell(toRow, toCol);
  targetCellEl.classList.add('merge-anim', 'merge-glow-anim');
  // merge-pop(0.35s)ã¨merge-glow(0.55s)ã‚’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§å‰Šé™¤ï¼ˆãƒªã‚¹ãƒŠãƒ¼ãƒªãƒ¼ã‚¯ã‚’é˜²ãï¼‰
  setTimeout(() => targetCellEl.classList.remove('merge-anim'), 360);
  setTimeout(() => targetCellEl.classList.remove('merge-glow-anim'), 560);

  // ç©ºã«ãªã£ãŸã‚»ãƒ«ã‚’ã‚¯ãƒªã‚¢è¡¨ç¤ºï¼ˆmerge-from-anim ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å®Ÿè¡Œï¼‰

  // ä¸Šã‹ã‚‰è£œå……ï¼ˆé‡åŠ›è½ä¸‹ï¼‰
  replenishColumn(fromCol);

  updateScoreBar();
  renderCompendium();

  // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®šï¼ˆè£œå……å¾Œã«å°‘ã—é…å»¶ã—ã¦ç¢ºèªï¼‰
  setTimeout(() => {
    if (isGameOver()) triggerGameOver();
  }, 600);
}

// =====================================================
// åˆ—è£œå……ï¼ˆé‡åŠ›ï¼‰: ç©ºã«ãªã£ãŸã‚»ãƒ«ã«ä¸Šã‹ã‚‰æ–°å…ƒç´ ã‚’è½ã¨ã™
// 2048ãƒ©ã‚¤ã‚¯ã«ã€Œç©ºã‚»ãƒ«ãŒã‚ã‚Œã°ä¸Šã‹ã‚‰æ–°è¦ç´ ã‚’è£œå……ã€ã™ã‚‹
// =====================================================
function replenishColumn(col) {
  // ä¸Šâ†’ä¸‹ã®é †ã§nullã‚’æ¢ã—ã€ä¸Šã‹ã‚‰è©°ã‚ã‚‹
  const column = [];
  for (let r = 0; r < GRID_SIZE; r++) {
    column.push(grid[r][col]);
  }

  // nullä»¥å¤–ã‚’å…ˆã«é›†ã‚ã€è¶³ã‚Šãªã„åˆ†ã‚’ãƒ©ãƒ³ãƒ€ãƒ è£œå……
  const filled = column.filter(v => v !== null);
  while (filled.length < GRID_SIZE) {
    // Layer2å…ƒç´ ã¯ã¾ã‚Œã«ï¼ˆ8%ï¼‰å‡ºç¾ã—ã€åŸºæœ¬ã¯åŸºæœ¬å…ƒç´ ã‚’è£œå……ã™ã‚‹
    // 20å…ƒç´ ã§ã‚‚é›£æ˜“åº¦ãŒæ€¥ä¸Šæ˜‡ã—ãªã„ã‚ˆã†ã€è£œå……ã¯åŸºæœ¬å…ƒç´ ä¸­å¿ƒã«ä¿ã¤
    const RARE_SPAWNS = ['lava', 'storm', 'ice', 'sand'];
    filled.unshift(
      Math.random() < 0.08
        ? RARE_SPAWNS[Math.floor(Math.random() * RARE_SPAWNS.length)]
        : BASE_ELEMENTS[Math.floor(Math.random() * BASE_ELEMENTS.length)]
    );
  }

  for (let r = 0; r < GRID_SIZE; r++) {
    const old = grid[r][col];
    grid[r][col] = filled[r];
    if (old !== filled[r]) {
      // æ–°ã—ãé™ã£ã¦ããŸã‚»ãƒ«ã«è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      const cellEl = getCellEl(r, col);
      renderCell(r, col);
      cellEl.classList.add('fall-anim');
      cellEl.addEventListener('animationend', () => {
        cellEl.classList.remove('fall-anim');
      }, { once: true });
    }
  }
}

// =====================================================
// ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
// ã€ŒåŒç¨®ã®éš£æ¥ãƒšã‚¢ãŒå…¨ããªã„ã€= ãƒãƒ¼ã‚¸ä¸å¯èƒ½
// å®Ÿè£…ã‚’ç°¡æ½”ã«ã™ã‚‹ãŸã‚å…¨ã‚»ãƒ«ã‚’èµ°æŸ»ã—ã¦ãƒšã‚¢ã‚’æ¢ã™
// =====================================================
function isGameOver() {
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      const id = grid[r][c];
      if (!id) continue;
      // å³ã¨ä¸‹ã®éš£æ¥ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆgetMergeResultã§ç•°ç¨®åˆæˆã‚‚å«ã‚ã¦åˆ¤å®šï¼‰
      if (c + 1 < GRID_SIZE && grid[r][c+1] && getMergeResult(id, grid[r][c+1])) return false;
      if (r + 1 < GRID_SIZE && grid[r+1][c] && getMergeResult(id, grid[r+1][c])) return false;
    }
  }
  return true; // åˆæˆå¯èƒ½ãƒšã‚¢ãŒã‚¼ãƒ­
}

function triggerGameOver() {
  gameOver = true;
  _showMidgameAd(); // CrazyGames: ãƒŸãƒƒãƒ‰ã‚²ãƒ¼ãƒ åºƒå‘Šãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆéåŒæœŸã€UIè¡¨ç¤ºã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
  const total = Object.keys(ELEMENTS).filter(id => !ELEMENTS[id].hidden).length;
  const discCount = Object.keys(discovered).filter(id => !ELEMENTS[id].hidden).length;
  finalScoreEl.textContent = score.toLocaleString();
  finalDiscEl.textContent = `${discCount} / ${total} elements discovered`;

  // æ˜Ÿè©•ä¾¡ï¼ˆç™ºè¦‹æ•°ã«åŸºã¥ã5æ®µéšï¼‰
  const ratio = discCount / total;
  const stars = ratio >= 0.95 ? 5 : ratio >= 0.75 ? 4 : ratio >= 0.5 ? 3 : ratio >= 0.25 ? 2 : 1;
  const starsEl = document.getElementById('final-stars');
  starsEl.textContent = 'â­'.repeat(stars) + 'â˜†'.repeat(5 - stars);

  // NEW BESTåˆ¤å®š
  const bestEl = document.getElementById('final-best-label');
  const prevBest = getBestScore();
  if (score > prevBest) {
    saveBestScore(score);
    bestEl.innerHTML = '<span class="final-best-badge">ğŸ† NEW BEST!</span>';
  } else {
    bestEl.innerHTML = `<span style="font-size:12px;color:var(--text-muted)">Best: ${prevBest.toLocaleString()}</span>`;
  }

  gameoverModal.classList.add('show');
}

function shuffleGrid() {
  // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ã‚°ãƒªãƒƒãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¹ã‚³ã‚¢ãƒ»å›³é‘‘ã¯ä¿æŒï¼‰
  gameoverModal.classList.remove('show');
  gameOver = false;
  _gameplayStart(); // CrazyGames: ã‚·ãƒ£ãƒƒãƒ•ãƒ«å¾Œã®ã‚²ãƒ¼ãƒ å†é–‹ã‚’é€šçŸ¥
  score = Math.max(0, score - 500); // -500pts ãƒšãƒŠãƒ«ãƒ†ã‚£

  // ã‚°ãƒªãƒƒãƒ‰å…¨ä½“ã‚’Layer1è¦ç´ ã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆé€²è¡ŒçŠ¶æ³ã‚’æ‰“ç ´ï¼‰
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      // 25%ã®ç¢ºç‡ã§Layer2ã‚’æ®‹ã—ã€ãã‚Œä»¥å¤–ã¯Layer1ã«æˆ»ã™ï¼ˆå¤šæ§˜æ€§ã‚’ä¿ã¤ï¼‰
      const elem = ELEMENTS[grid[r][c]];
      if (elem && elem.layer >= 3) {
        grid[r][c] = BASE_ELEMENTS[Math.floor(Math.random() * BASE_ELEMENTS.length)];
      }
    }
  }

  selectedCell = null;
  droppableCells = [];
  updateScoreBar();
  renderGrid();
}

// =====================================================
// ã‚³ãƒ³ãƒœç®¡ç†
// 1500msä»¥å†…ã«é€£ç¶šåˆæˆã™ã‚‹ã¨comboãŒã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹
// =====================================================
function incrementCombo() {
  combo++;
  if (comboTimer) clearTimeout(comboTimer);
  comboTimer = setTimeout(() => {
    combo = 0;
    updateComboDisplay();
    comboTimer = null;
  }, COMBO_WINDOW);
  updateComboDisplay();
}

function updateComboDisplay() {
  if (combo >= 2) {
    comboEl.textContent = `Ã—${combo} COMBO!`;
    comboEl.className = 'combo-show';
    comboEl.style.animation = 'none';
    // reflow trigger
    void comboEl.offsetWidth;
    comboEl.style.animation = 'combo-bounce 0.3s ease-out';
  } else {
    comboEl.className = 'combo-hidden';
  }
}

// =====================================================
// VFX: ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«çˆ†ç™º
// =====================================================
// rainbow colors for Layer4 particles
const RAINBOW = ['#ff6b6b','#ffd93d','#6bcb77','#4ecdc4','#a29bfe','#fd79a8','#fdcb6e'];

// =====================================================
// VFX: ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¹ã‚³ã‚¢æ¼”å‡º (+ptsãŒåˆæˆä½ç½®ã‹ã‚‰ä¸Šã«é£›ã¶)
// =====================================================
function showFloatingScore(x, y, pts, layer) {
  const el = document.createElement('div');
  el.className = 'floating-score';
  // Layerã«å¿œã˜ã¦è‰²ã‚’å¤‰ãˆã‚‹
  const color = layer >= 4 ? '#e040fb' : layer === 3 ? '#ab47bc' : '#ffd700';
  const prefix = combo >= 2 ? `Ã—${combo} ` : '';
  el.textContent = `${prefix}+${pts.toLocaleString()}`;
  el.style.cssText = `left:${x}px; top:${y}px; color:${color}; font-size:${layer >= 3 ? 22 : 18}px;`;
  document.body.appendChild(el);
  el.addEventListener('animationend', () => el.remove(), { once: true });
}

// =====================================================
// æœ€é«˜ã‚¹ã‚³ã‚¢ç®¡ç† (localStorageã§æ°¸ç¶šåŒ–)
// =====================================================
function getBestScore() {
  try { return parseInt(localStorage.getItem('primalfuse_best') || '0'); } catch { return 0; }
}
function saveBestScore(s) {
  try { localStorage.setItem('primalfuse_best', String(s)); } catch {}
}

function spawnParticles(cx, cy, color, count = 8, rainbow = false) {
  for (let i = 0; i < count; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const angle = (i / count) * Math.PI * 2 + Math.random() * 0.3;
    const dist = 40 + Math.random() * 50;
    const dx = Math.cos(angle) * dist;
    const dy = Math.sin(angle) * dist;
    const c = rainbow ? RAINBOW[i % RAINBOW.length] : color;
    p.style.cssText = `
      left: ${cx - 3.5}px;
      top:  ${cy - 3.5}px;
      background: ${c};
      width: ${rainbow ? 9 : 7}px;
      height: ${rainbow ? 9 : 7}px;
      --dx: ${dx}px;
      --dy: ${dy}px;
    `;
    document.body.appendChild(p);
    p.addEventListener('animationend', () => p.remove(), { once: true });
  }
}

// =====================================================
// VFX: ã‚°ãƒªãƒƒãƒ‰ã‚·ã‚§ã‚¤ã‚¯ (åˆæˆä¸å¯ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯)
// =====================================================
function shakeGrid() {
  const wrapper = document.querySelector('.grid-wrapper');
  wrapper.classList.remove('grid-shake');
  void wrapper.offsetWidth; // reflow
  wrapper.classList.add('grid-shake');
  wrapper.addEventListener('animationend', () => {
    wrapper.classList.remove('grid-shake');
  }, { once: true });
}

// =====================================================
// VFX: ç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ (Layer3ç™ºè¦‹æ™‚)
// =====================================================
const flashOverlay = document.getElementById('flash-overlay');
function flashScreen() {
  flashOverlay.classList.add('active');
  setTimeout(() => flashOverlay.classList.remove('active'), 180);
}

// =====================================================
// VFX: è™¹è‰²ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ (Layer4ç™ºè¦‹æ™‚ â€” ç©¶æ¥µæ¼”å‡º)
// =====================================================
function rainbowFlash() {
  flashOverlay.classList.add('active', 'rainbow');
  setTimeout(() => {
    flashOverlay.classList.remove('active', 'rainbow');
  }, 600);
  // è¿½åŠ : ã‚¹ã‚¯ãƒªãƒ¼ãƒ³å…¨ä½“ã‚’ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã§åŒ…ã‚€
  for (let i = 0; i < 6; i++) {
    setTimeout(() => {
      spawnParticles(
        window.innerWidth * (0.2 + Math.random() * 0.6),
        window.innerHeight * (0.2 + Math.random() * 0.6),
        '#fff', 12, true
      );
    }, i * 80);
  }
}

// =====================================================
// æ–°ç™ºè¦‹æ¼”å‡º
// =====================================================
let toastTimer = null;

function showDiscoveryToast(elementId) {
  const elem = ELEMENTS[elementId];
  lastDiscoveredId = elementId; // å…±æœ‰å¯¾è±¡ã‚’æ›´æ–°
  toastEmoji.textContent = elem.emoji;
  toastName.textContent = elem.label;

  // Layerã«å¿œã˜ãŸæ¼”å‡º
  toast.classList.remove('layer3', 'layer4');
  if (elem.layer >= 4) {
    toast.classList.add('layer4');
    toastLayer.textContent = 'âœ¨ ULTIMATE DISCOVERY! âœ¨';
    toastLayer.className = 'toast-layer legendary';
  } else if (elem.layer === 3) {
    toast.classList.add('layer3');
    toastLayer.textContent = 'RARE DISCOVERY!';
    toastLayer.className = 'toast-layer rare';
  } else {
    toastLayer.textContent = `Layer ${elem.layer} element`;
    toastLayer.className = 'toast-layer';
  }

  if (toastTimer) clearTimeout(toastTimer);
  toast.classList.add('show');

  toastTimer = setTimeout(() => {
    toast.classList.remove('show');
    toastTimer = null;
  }, 2000);
}

// =====================================================
// ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
// =====================================================
function renderGrid() {
  gridEl.innerHTML = '';
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      const cellEl = document.createElement('div');
      cellEl.className = 'cell';
      cellEl.dataset.row = r;
      cellEl.dataset.col = c;

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      cellEl.addEventListener('click', () => clickCell(r, c));

      gridEl.appendChild(cellEl);
      renderCell(r, c); // å†…å®¹ã‚’æç”»
    }
  }

}
// ã‚¿ãƒƒãƒã‚µãƒãƒ¼ãƒˆã¯renderGridã§ã¯ãªãåˆæœŸåŒ–æ™‚ã«ä¸€åº¦ã ã‘ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ï¼ˆä¸‹éƒ¨ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆå‚ç…§ï¼‰

// ã‚»ãƒ«å˜ä½“ã®å†…å®¹ã‚’æ›´æ–°ï¼ˆinnerHTMLå…¨æ›´æ–°ã‚ˆã‚Šé«˜é€Ÿï¼‰
function renderCell(row, col) {
  const cellEl = getCellEl(row, col);
  const elemId = grid[row][col];

  // æ—¢å­˜ã®é¸æŠ/ãƒ‰ãƒ­ãƒƒãƒ—çŠ¶æ…‹ã‚¯ãƒ©ã‚¹ã¯ä¿æŒã—ã¤ã¤å†…å®¹ã‚’æ›´æ–°
  cellEl.classList.remove('merge-anim', 'fall-anim');

  if (!elemId) {
    cellEl.classList.add('empty');
    cellEl.innerHTML = '';
    cellEl.style.borderColor = '';
    cellEl.style.background = '';
    return;
  }

  cellEl.classList.remove('empty');
  const elem = ELEMENTS[elemId];
  cellEl.innerHTML = `
    <span class="emoji">${elem.emoji}</span>
    <span class="label" style="color:${elem.color}">${elem.label}</span>
  `;
  // ãƒœãƒ¼ãƒ€ãƒ¼è‰²ã§å…ƒç´ ã®ç¨®é¡ã‚’ç¤ºã™ï¼ˆé¸æŠä¸­ã¯ä¸Šæ›¸ãã•ã‚Œã‚‹ï¼‰
  cellEl.style.borderColor = elem.color + '55'; // è–„ã‚
  cellEl.style.background = elem.color + '18';  // ã•ã‚‰ã«è–„ã‚
}

function renderCompendium() {
  compendiumEl.innerHTML = '';
  // hiddenè¦ç´ ï¼ˆghostç­‰ï¼‰ã¯å›³é‘‘ã«è¡¨ç¤ºã—ãªã„
  const allIds = Object.keys(ELEMENTS).filter(id => !ELEMENTS[id].hidden);

  allIds.forEach(id => {
    const elem = ELEMENTS[id];
    const isDisc = !!discovered[id];
    const item = document.createElement('div');
    item.className = `comp-item ${isDisc ? 'discovered' : 'undiscovered'}`;

    item.innerHTML = `
      <span class="comp-emoji">${elem.emoji}</span>
      <span class="comp-name" style="${isDisc ? `color:${elem.color}` : ''}">${isDisc ? elem.label : '???'}</span>
    `;
    compendiumEl.appendChild(item);
  });
}

let victoryShown = false; // é‡è¤‡æ¼”å‡ºé˜²æ­¢

function updateScoreBar() {
  // hiddenè¦ç´ ï¼ˆghostç­‰ï¼‰ã¯å›³é‘‘ã‚«ã‚¦ãƒ³ãƒˆãƒ»å‹åˆ©æ¡ä»¶ã‹ã‚‰é™¤å¤–ã™ã‚‹
  const total = Object.keys(ELEMENTS).filter(id => !ELEMENTS[id].hidden).length;
  const count = Object.keys(discovered).filter(id => !ELEMENTS[id].hidden).length;
  discCountEl.textContent = `${count} / ${total}`;
  scoreEl.textContent = score.toLocaleString();
  // ã‚¹ã‚³ã‚¢å¤‰åŒ–æ™‚ã«ãƒãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  scoreEl.classList.remove('pop');
  void scoreEl.offsetWidth;
  scoreEl.classList.add('pop');

  // å…¨ç™ºè¦‹ã§VICTORYæ¼”å‡ºï¼ˆ1å›ã®ã¿ï¼‰
  if (!victoryShown && count >= total) {
    victoryShown = true;
    setTimeout(triggerVictory, 800);
  }
}

function triggerVictory() {
  _happytime(); // CrazyGames: Compendiumå®Œæˆï¼ãƒãƒƒãƒ”ãƒ¼ã‚¿ã‚¤ãƒ æ¼”å‡º
  document.getElementById('victory-score').textContent = score.toLocaleString();
  document.getElementById('victory-modal').classList.add('show');
  // ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ•ãƒ©ãƒƒã‚·ãƒ¥Ã—3
  let flashes = 0;
  const flash = setInterval(() => {
    rainbowFlash();
    flashes++;
    if (flashes >= 3) clearInterval(flash);
  }, 600);
}

function shareVictory() {
  const total = Object.keys(ELEMENTS).filter(id => !ELEMENTS[id].hidden).length;
  const text = `ğŸ‘» I freed ALL ${total} ghosts from the machine in Primal Fuse!\nğŸ† Score: ${score.toLocaleString()}\n\nCan you decode the Primal Fuse? #PrimalFuse #AIBrowserGameJam #puzzle`;
  const url = 'https://yurukusa.itch.io/primal-fuse';
  if (navigator.share) {
    navigator.share({ title: 'Primal Fuse â€” Ghost Decoded!', text, url }).catch(() => {});
  } else {
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text + '\n' + url)}`, '_blank', 'noopener');
  }
}

// =====================================================
// ã‚¿ãƒƒãƒæ“ä½œï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
// touchstartâ†’touchmoveï¼ˆãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰â†’touchendï¼ˆç¢ºå®šï¼‰
// setupTouchEventsã¯åˆæœŸåŒ–æ™‚ã«ä¸€åº¦ã ã‘å‘¼ã¶ã€‚renderGrid()ã‹ã‚‰ã¯å‘¼ã°ãªã„ã€‚
// =====================================================
let _touchEventsInitialized = false; // äºŒé‡ç™»éŒ²ã‚’é˜²ããƒ•ãƒ©ã‚°

function setupTouchEvents() {
  if (_touchEventsInitialized) return; // äºŒé‡ç™»éŒ²é˜²æ­¢
  _touchEventsInitialized = true;

  let touchStartCell = null;
  let lastHoverCell = null; // touchmoveã§æœ€å¾Œã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ãŸã‚»ãƒ«

  // ã‚¿ãƒƒãƒä¸­ã®ã‚»ãƒ«ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹å…±é€šé–¢æ•°
  function clearTouchHover() {
    if (lastHoverCell) {
      lastHoverCell.classList.remove('touch-hover');
      lastHoverCell = null;
    }
  }

  gridEl.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    const target = document.elementFromPoint(touch.clientX, touch.clientY);
    const cellEl = target?.closest('.cell');
    if (!cellEl) return;
    touchStartCell = {
      row: parseInt(cellEl.dataset.row),
      col: parseInt(cellEl.dataset.col),
    };
  }, { passive: false });

  // touchmove: ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«æŒ‡ã®ä¸‹ã®ã‚»ãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æŠ‘åˆ¶
  gridEl.addEventListener('touchmove', (e) => {
    e.preventDefault(); // ã‚°ãƒªãƒƒãƒ‰ä¸Šã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Œå…¨ã«æŠ‘åˆ¶
    if (!touchStartCell) return;

    const touch = e.touches[0];
    const target = document.elementFromPoint(touch.clientX, touch.clientY);
    const cellEl = target?.closest('.cell');

    clearTouchHover();
    if (cellEl) {
      // ãƒ‰ãƒ©ãƒƒã‚°å…ƒä»¥å¤–ã®ã‚»ãƒ«ã«ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ä»˜ã‘ã‚‹
      const hoverRow = parseInt(cellEl.dataset.row);
      const hoverCol = parseInt(cellEl.dataset.col);
      if (!(hoverRow === touchStartCell.row && hoverCol === touchStartCell.col)) {
        cellEl.classList.add('touch-hover');
        lastHoverCell = cellEl;
      }
    }
  }, { passive: false });

  gridEl.addEventListener('touchend', (e) => {
    e.preventDefault();
    clearTouchHover(); // ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã«ãƒ›ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢

    const touch = e.changedTouches[0];
    const target = document.elementFromPoint(touch.clientX, touch.clientY);
    const cellEl = target?.closest('.cell');
    if (!cellEl || !touchStartCell) { touchStartCell = null; return; }

    const endRow = parseInt(cellEl.dataset.row);
    const endCol = parseInt(cellEl.dataset.col);

    if (touchStartCell.row === endRow && touchStartCell.col === endCol) {
      // åŒã‚»ãƒ«ã‚¿ãƒƒãƒ— = ã‚¯ãƒªãƒƒã‚¯ã¨åŒç­‰
      clickCell(endRow, endCol);
    } else {
      // åˆ¥ã‚»ãƒ«ã¸ã®ã‚¹ãƒ¯ã‚¤ãƒ—: é–‹å§‹ã‚»ãƒ«ã‚’é¸æŠâ†’çµ‚äº†ã‚»ãƒ«ã«ãƒ‰ãƒ­ãƒƒãƒ—
      if (!selectedCell) {
        selectCell(touchStartCell.row, touchStartCell.col);
      }
      clickCell(endRow, endCol);
    }
    touchStartCell = null;
  }, { passive: false });

  // ã‚°ãƒªãƒƒãƒ‰å¤–ã§ã®touchcancelã«ã‚‚å¯¾å¿œï¼ˆé›»è©±ç€ä¿¡ãªã©ã§ä¸­æ–­ã•ã‚ŒãŸæ™‚ï¼‰
  gridEl.addEventListener('touchcancel', () => {
    clearTouchHover();
    touchStartCell = null;
  });
}

// =====================================================
// ç™ºè¦‹å…±æœ‰ â€” Web Share API (ãƒ¢ãƒã‚¤ãƒ«) / Twitter intent (PC)
// ã€Œã“ã®å…ƒç´ ç™ºè¦‹ã—ãŸï¼ã€ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚¹ãƒˆã•ã›ã¦ãƒã‚¤ãƒ©ãƒ«æ‹¡æ•£
// =====================================================
let lastDiscoveredId = null; // å…±æœ‰å¯¾è±¡ã®æœ€æ–°ç™ºè¦‹å…ƒç´ 

function shareDiscovery() {
  if (!lastDiscoveredId) return;
  const elem = ELEMENTS[lastDiscoveredId];
  const discCount = Object.keys(discovered).filter(id => !ELEMENTS[id].hidden).length;
  const total = Object.keys(ELEMENTS).filter(id => !ELEMENTS[id].hidden).length;
  const layerLabel = elem.layer >= 4 ? 'âœ¨ ULTIMATE' : elem.layer === 3 ? 'âš¡ RARE' : `Layer ${elem.layer}`;
  const text = `${elem.emoji} Discovered "${elem.label}"! ${layerLabel}\nğŸ† Score: ${score.toLocaleString()} â€” ${discCount}/${total} elements found\n\n#PrimalFuse #AIBrowserGameJam #puzzle`;
  const url = 'https://yurukusa.itch.io/primal-fuse';

  if (navigator.share) {
    // ãƒ¢ãƒã‚¤ãƒ«: ãƒã‚¤ãƒ†ã‚£ãƒ–å…±æœ‰ã‚·ãƒ¼ãƒˆ
    navigator.share({ title: 'Primal Fuse â€” Element Discovery', text, url }).catch(() => {});
  } else {
    // PC: Xã¸ã®ãƒªãƒ³ã‚¯
    window.open(
      `https://twitter.com/intent/tweet?text=${encodeURIComponent(text + '\n' + url)}`,
      '_blank', 'noopener'
    );
  }
}

// =====================================================
// Hintãƒœã‚¿ãƒ³: åˆæˆå¯èƒ½ãƒšã‚¢ã‚’1çµ„ãƒã‚¤ãƒ©ã‚¤ãƒˆ

let hintCooldownTimer = null;

function showHint() {
  const btn = document.getElementById('hint-btn');
  if (btn.disabled) return;

  // å…¨ã‚»ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦åˆæˆå¯èƒ½ãªãƒšã‚¢ã‚’æ¢ã™
  const pairs = [];
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      if (!grid[r][c]) continue;
      const neighbors = [[r-1,c],[r+1,c],[r,c-1],[r,c+1]];
      for (const [nr, nc] of neighbors) {
        if (nr < 0 || nr >= GRID_SIZE || nc < 0 || nc >= GRID_SIZE) continue;
        if (!grid[nr][nc]) continue;
        if (getMergeResult(grid[r][c], grid[nr][nc])) {
          // é‡è¤‡æ’é™¤: (r,c)â†’(nr,nc) ã¨ (nr,nc)â†’(r,c) ã¯åŒã˜ãƒšã‚¢
          if (r < nr || (r === nr && c < nc)) {
            pairs.push([[r,c],[nr,nc]]);
          }
        }
      }
    }
  }

  if (pairs.length === 0) {
    // åˆæˆä¸å¯èƒ½ã‚’è¦–è¦šçš„ã«ä¼ãˆã‚‹ï¼ˆã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å¯¸å‰ã®è­¦å‘Šï¼‰
    btn.textContent = 'âš ï¸ No moves!';
    setTimeout(() => { btn.textContent = 'ğŸ’¡ Hint'; }, 2000);
    return;
  }

  // ãƒ©ãƒ³ãƒ€ãƒ ã«1ãƒšã‚¢é¸ã‚“ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ
  const [[r1,c1],[r2,c2]] = pairs[Math.floor(Math.random() * pairs.length)];
  const cellAt = (r, c) => document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
  const el1 = cellAt(r1, c1);
  const el2 = cellAt(r2, c2);
  if (el1) el1.classList.add('hint-pair');
  if (el2) el2.classList.add('hint-pair');

  // 1.5ç§’å¾Œã«ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
  setTimeout(() => {
    if (el1) el1.classList.remove('hint-pair');
    if (el2) el2.classList.remove('hint-pair');
  }, 1500);

  // 3ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
  btn.disabled = true;
  btn.textContent = 'â³ Hint';
  clearTimeout(hintCooldownTimer);
  hintCooldownTimer = setTimeout(() => {
    btn.disabled = false;
    btn.textContent = 'ğŸ’¡ Hint';
  }, 3000);
}

// =====================================================
// localStorageã¸ã®å›³é‘‘ä¿å­˜
// JSON.stringifyãŒå¤±æ•—ã™ã‚‹ç’°å¢ƒï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°ç­‰ï¼‰ã«å‚™ãˆã¦try/catch
// =====================================================
function saveDiscovered() {
  try {
    localStorage.setItem('primalfuse_discovered', JSON.stringify(discovered));
  } catch {
    // localStorageãŒä½¿ãˆãªãã¦ã‚‚å‹•ä½œã¯ç¶™ç¶šã™ã‚‹
  }
}

// =====================================================
// åˆå›ãƒ—ãƒ¬ã‚¤ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
// åˆå›ã®ã¿: 1.5ç§’å¾Œã«åˆæˆãƒšã‚¢ã‚’è‡ªå‹•ãƒã‚¤ãƒ©ã‚¤ãƒˆ + ãƒãƒ–ãƒ«è¡¨ç¤º
// =====================================================
function maybeShowTutorial() {
  let isFirst = false;
  try {
    if (!localStorage.getItem('primalfuse_tutorial_done')) {
      isFirst = true;
      localStorage.setItem('primalfuse_tutorial_done', '1');
    }
  } catch {
    isFirst = true; // localStorageä½¿ãˆãªã„ç’°å¢ƒã§ã¯æ¯å›è¡¨ç¤º
  }
  if (!isFirst) return;

  setTimeout(() => {
    if (gameOver || selectedCell) return; // ã™ã§ã«æ“ä½œä¸­ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
    showHint(); // åˆæˆãƒšã‚¢ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ

    const bubble = document.getElementById('tutorial-bubble');
    bubble.classList.add('show');
    setTimeout(() => { bubble.classList.remove('show'); }, 3000);
  }, 1500);
}

// =====================================================
// ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
// =====================================================
initGame();
setupTouchEvents(); // ä¸€åº¦ã ã‘ç™»éŒ²ï¼ˆrenderGridå†…ã«ã¯ç½®ã‹ãªã„ï¼‰
maybeShowTutorial();
</script>
</body>
</html>
